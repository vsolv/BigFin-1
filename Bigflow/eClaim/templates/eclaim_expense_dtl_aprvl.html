{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} eClaim Expense{% endblock %}
{% csrf_token %}
{% block content %}
{% verbatim %}
<div class="maincontent">
    <div class="container container1" ng-app="dateapp" ng-cloak ng-controller="datectrl" ng-cloak>
        <md-subheader ng-show="onbehalf_emp_heder" class="md-accent">On BeHalf Employee - {{onbehalf_emp}}
        </md-subheader>
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>eClaim Expense Approval </h4>
            </div>
        </div>
        &nbsp;
        &nbsp;
        &nbsp;
        <div class="row table-responsive">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                    <thead class="header">
                    <th class="text-center" scope="col">S.No</th>
                    <!--                    <th class="text-center" scope="col">Expense Code</th>-->
                    <th class="text-center" scope="col">Description</th>
                    <th class="text-center" scope="col">Eligible Amount</th>
                    <th class="text-center" scope="col">Claim Amount</th>
                    <th class="text-center" scope="col" ng-show="applevel == 2 || claimstatus == 'APPROVED'">Approved
                        Amount
                    </th>
                    <th class="text-center" scope="col">Requester Comment</th>
                    <th class="text-center" scope="col">Expense Details</th>
                    </thead>

                    <tbody>
                    <tr ng-repeat="eClaim in eClaim_approval.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage)) | orderBy:orderByField:reverseSort">
                        <td class="text-center">
                            <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                        </td>
                        <!--                        <td class="text-center">{{eClaim.expsensecode}}</td>-->
                        <td class="text-center">{{eClaim.description}}</td>
                        <td class="text-right">{{eClaim.eligibleamount}}</td>
                        <td class="text-right">{{eClaim.claimedamount}}</td>
                        <td class="text-right" ng-show="applevel == 2 || claimstatus == 'APPROVED'">
                            {{eClaim.approvedamount}}
                        </td>
                        <td class="text-center">{{eClaim.requestorcomment}}</td>
                        <td class="text-center" ng-click="expense_view(eClaim)">
                            <a href=""><i class="material-icons">
                                visibility
                            </i></a>
                    </tr>
                    <tr ng-show="asset_check.length ==  0">
                        <td class="warning" colspan="13">
                            No Records Found.
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="2">
                            <ul boundary-links="true" class="pagination-sm cust_pagination"
                                items-per-page="itemsPerPage"
                                max-size="maxSize"
                                ng-model="currentPage" total-items="eClaim_approval.length"
                                uib-pagination></ul>
                        </td>
                        <td class="text-left" colspan="1">
                            <span>Total Eligible Amount:<br/> <b
                                    class="text-right"> {{total_eligamount}}</b></span>
                        </td>
                        <td class="text-left" colspan="1">
                            <span>Total Claim Amount:<br/> <b
                                    class="text-right"> {{total_claimamount}}</b></span>
                        </td>
                        <td ng-show="applevel == 2 || claimstatus == 'APPROVED'" class="text-left" colspan="1">
                            <span>Total Approved Amount:<br/> <b
                                    class="text-right"> {{total_approveamount}}</b></span>
                        </td>
                        <td class="text-left" colspan="2">
                            <md-button class="btn btn-info custbutton"
                                       ng-click="attachment()">View Uploaded Documents
                                <md-tooltip>Expense Attachment</md-tooltip>
                            </md-button>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="row" ng-show="applevel == 2 || claimstatus == 'APPROVED'" class="col-md-12">
                    <md-subheader class="md-accent">CCBS</md-subheader>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="col-md-3">
                                <md-button class="btn btn-info custbutton"
                                           class="md-raised"
                                           ng-click="add_ccbs($index,eclaim)">CCBS
                                    <md-tooltip>Add CCBS</md-tooltip>
                                </md-button>
                            </div>
                        </div>
                    </div>
                </div>
        <!--Image start-->
        <div aria-hidden="" aria-labelledby="exampleModalLabel"
             class="modal fade"
             data-backdrop="" data-keyboard="false"
             id="attach_view">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <strong>eClaim Expense Attachment View</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <div class="row">
                                <div class="col-lg-12 col-sm-12">
                                    <div ng-repeat="file in files" class="text-center">
                                            <img ng-show="file.type =='image'" src="{{ file.file_path }}"
                                                 style="width:870px;height:500px"/>
                                            <iframe ng-show="file.type =='pdf'" ng-src="{{file.file_path}}"
                                                    style="width:870px;height:500px"></iframe>
                                            <br/>
<!--                                        <object width="870px" height="500px"-->
<!--                                                data="{{file.file_path}}" class="internal">-->
<!--                                            <embed src="{{file.file_path}}"/>-->
<!--                                            <br/>-->
<!--                                        </object>-->
                                        <br/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div ng-show="Reject_opt">
            <md-subheader class="md-accent">To Reject</md-subheader>
            <form name="expense_valid" novalidate role="form">
                <div class="col-md-4">
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Rejection Reason</label>
                            <textarea class="textboxline"
                                      placeholder="Comments for reject"
                                      style="width:500px"
                                      ng-pattern="/^[^`~@#$%\^&*()_+={}|[\]\\:';<>?!/]*$/"
                                      maxlength="500"
                                      name="comments"
                                      ng-model="comments" required>
                            </textarea>
                            <span class="error" style="color:red"
                                  ng-show="expense_valid.comments.$error.pattern">Special char Error</span>
                            {{myForm.$error}}
                        </div>
                        <div class="col-md-2">
                            <md-button class="md-icon-button"
                                       ng-disabled="expense_valid.$invalid"
                                       aria-label="Reject"
                                       ng-click="reject_expense()">
                                <md-icon class="material-icons editlink">done</md-icon>
                                <md-tooltip>Reject</md-tooltip>
                            </md-button>
                        </div>
                        <div class="col-md-2">
                            <md-button class="md-icon-button"
                                       aria-label="Reject"
                                       ng-click="close_reject()">
                                <md-icon class="material-icons editlink">close</md-icon>
                                <md-tooltip>Close Reject</md-tooltip>
                            </md-button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div ng-show="return_reason">
            <form name="expense_valid" novalidate role="form">
                <div class="col-md-4">
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Return Reason</label>
                            <textarea class="textboxline"
                                      placeholder="Comments for Return"
                                      style="width:500px"
                                      ng-pattern="/^[^`~@#$%\^&*()_+={}|[\]\\:';<>?!/]*$/"
                                      maxlength="500"
                                      ng-model="comments"
                                      name="comments"
                                      required>
                            </textarea>
                            <span class="error" style="color:red"
                                  ng-show="expense_valid.comments.$error.pattern">Special char Error</span>
                            {{myForm.$error}}
                        </div>
                        <div class="col-md-2">
                            <md-button class="md-icon-button"
                                       ng-disabled="expense_valid.$invalid"
                                       aria-label="Reject"
                                       ng-click="direct_return()">
                                <md-icon class="material-icons editlink">done</md-icon>
                                <md-tooltip>Return</md-tooltip>
                            </md-button>
                        </div>
                        <div class="col-md-2">
                            <md-button class="md-icon-button" aria-label="Reject"
                                       ng-click="close_return()">
                                <md-icon class="material-icons editlink">close</md-icon>
                                <md-tooltip>Close</md-tooltip>
                            </md-button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div ng-show="Approve_opt" class="row" class="col-md-12">
            <md-subheader class="md-accent">To Approve</md-subheader>
            <form name="submit_valid" novalidate role="form">
                <div class="row">
                    <div class="col-md-12">
                        <div class="col-md-3">
                            <label>Branch</label>
                            <md-autocomplete
                                    md-item-text="item.branch_name"
                                    md-items="item in brsearch(searchbr)"
                                    md-min-length=0
                                    ng-disabled="status_check"
                                    md-search-text="searchbr"
                                    md-selected-item="selectedbr"
                                    md-selected-item-change="branchchange(item)"
                                    ng-required="true"
                                    placeholder="Branch">
                                <md-item-template>
                                    <span md-highlight-text="searchText"> {{item.branch_code}} {{item.branch_name}} </span>
                                </md-item-template>
                                <md-not-found>
                                    No Branch matching "{{searchbr}}" were found.
                                </md-not-found>
                            </md-autocomplete>
                        </div>
                        <div class="col-md-3">
                            <label>Employee</label>
                            <md-autocomplete
                                    md-item-text="item.employee_name"
                                    md-items="item in empsearch(searchemp)"
                                    md-min-length=0
                                    ng-disabled="status_check"
                                    md-no-cache="true"
                                    md-search-text="searchemp"
                                    md-selected-item="selectedemp"
                                    md-selected-item-change="selectchange(item)"
                                    ng-required="true"
                                    placeholder="Employee">
                                <md-item-template>
                                    <span md-highlight-text="searchText"> {{item.employee_name}} {{item.employee_code}} </span>
                                </md-item-template>
                                <md-not-found>
                                    No Employee matching "{{searchemp}}" were found.
                                </md-not-found>
                            </md-autocomplete>
                        </div>
                        <div class="col-md-3">
                            <label>Submit Comments</label>
                            <textarea ng-model="comments"
                                      ng-disabled="status_check"
                                      maxlength="500"
                                      ng-pattern="/^[^`~@#$%\^&*()_+={}|[\]\\:';<>?!/]*$/"
                                      style="width:500px"
                                      ng-model="comments"
                                      name="comments"
                                      ng-required="true" type="text">
                                </textarea>
                            <span class="error" style="color:red"
                                  ng-show="submit_valid.comments.$error.pattern">Special char Error</span>
                            {{myForm.$error}}
                        </div>
                        <div class="col-md-3 text-center">
                        </div>
                    </div>
                </div>
                <div class="row" ng-hide="approval_show">
                    <div class="col-md-12 text-center">
                        <md-button class="btn btn-info custbutton" ng-click="move_approve()"
                                   ng-disabled="submit_valid.$invalid">Submit
                            <md-tooltip>Submit</md-tooltip>
                        </md-button>
                        <md-button type="button" value="Reject"
                                   ng-click="move_reject()"
                                   ng-show="applevel == 1"
                                   class="md-raised md-warn">Reject
                        </md-button>
                        <md-button type="button" value="Return"
                                   ng-click="return(em)"
                                   ng-show="applevel == 1"
                                   ng-disabled="enable_return"
                                   class="md-raised">Return
                        </md-button>
                    </div>
                </div>
            </form>
        </div>
        <br/>
        <div class="row" ng-show="applevel == 2 || claimstatus == 'APPROVED'">
            <div class="row">
                <div class="col-md-4">
                </div>
                <div class="col-md-2">
                    <h5> Total Claimed Amount : </h5>
                </div>
                <div class="col-md-1">
                    <h5>{{total_claimamount}}</h5>
                </div>
                <div class="col-md-2">
                    <h5> Advance to be Adjusted : </h5>
                </div>
                <div class="col-md-1">
                    <h5>{{advanceamount}}</h5>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                </div>
                <div class="col-md-2">
                    <h5>Total Approved Amount :</h5>
                </div>
                <div class="col-md-1">
                    <h5>{{total_approveamount}}</h5>
                </div>
                <div class="col-md-2">
                    <h5 style="color:blue;"> Net Payable :</h5>
                </div>
                <div class="col-md-1">
                    <h5 style="color:blue;">{{net_amount}}</h5>
                </div>
            </div>
        </div>
        <div class="row" ng-show="Higher_authority">
            <form name="comds_valid" novalidate role="form">
                <div class="col-md-4">
                </div>
                <div class="col-md-5">
                    <label>Comments</label>
                    <textarea ng-model="comments"
                              style="width:500px"
                              ng-pattern="/^[^`~@#$%\^&*()_+={}|[\]\\:';<>?!/]*$/"
                              maxlength="500"
                              name="comments"
                              ng-required="true" type="text">
                        </textarea>
                    <span class="error" style="color:red"
                          ng-show="comds_valid.comments.$error.pattern">Special char Error</span>
                    {{myForm.$error}}
                </div>
                <div class="col-md-12 text-center">
                    <md-button class="btn btn-info custbutton"
                               ng-disabled="comds_valid.$invalid"
                               ng-click="direct_approve()">Approve
                        <md-tooltip>Approve</md-tooltip>
                    </md-button>
                    <md-button type="button" value="Reject"
                               ng-click="move_other()"
                               class="md-raised">Move to Other
                    </md-button>
                </div>
            </form>
        </div>
        <div ng-show="approvaldata" class="row">
            <div class="col-md-12">
                <md-subheader class="md-accent">Advance Adjust</md-subheader>
                <div class="row table-responsive ">
                    <div class="col-md-8 col-lg-8 col-sm-8">
                        <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                            <thead class="header">
                            <th class="text-center" scope="col">S.No</th>
                            <th class="text-center" scope="col">CRN No</th>
                            <th class="text-center" scope="col">Date</th>
                            <th class="text-center" scope="col">Amount</th>
                            <th class="text-center" scope="col">Balance</th>
                            </thead>
                            <tbody>
                            <tr ng-repeat="ad in advanceadjust_data.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage)) | orderBy:orderByField:reverseSort">
                                <td class="text-center">
                                    <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                                </td>
                                <td class="text-left">{{ad.ppxheader_crno}}</td>
                                <td class="text-left">{{ad.ppxheader_date}}</td>
                                <td class="text-left">{{ad.ppxheader_amount}}</td>
                                <td class="text-left">{{ad.ppxheader_balance}}</td>
                            </tr>
                            <tr ng-show="data_len ==  0">
                                <td class="warning" colspan="17">
                                    No Records Found.
                                </td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr>
                                <td colspan="5">
                                    <ul boundary-links="true" class="pagination-sm cust_pagination"
                                        items-per-page="itemsPerPage"
                                        max-size="maxSize"
                                        ng-model="currentPage" total-items="eClaim_tavels.length"
                                        uib-pagination></ul>
                                </td>
                                <!--                        <td class="text-left" colspan="1">-->
                                <!--                            <span>Total Count:<br/> <b class="text-centre"> {{eClaim_tavels.length}}</b></span>-->
                                <!--                        </td>-->
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div ng-show="approvaldata" class="row">
            <div class="col-md-12">
                <md-subheader class="md-accent">Approval Flow</md-subheader>
                <div class="row table-responsive">
                    <div class="col-md-8 col-lg-8 col-sm-8">
                        <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                            <thead class="header">
                            <th class="text-center" scope="col">S.No</th>
                            <th class="text-center" scope="col">Employee</th>
                            <th class="text-center" scope="col">Raisedby</th>
                            <th class="text-center" scope="col">Type</th>
                            <th class="text-center" scope="col">Date</th>
                            <th class="text-center" scope="col">Comment</th>
                            <th class="text-center" scope="col">Status</th>
                            </thead>
                            <tbody>
                            <tr ng-repeat="apprl in get_approval_data.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage)) | orderBy:orderByField:reverseSort">
                                <td class="text-center">
                                    <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                                </td>
                                <td class="text-center">{{apprl.employee_name}} - {{apprl.employee_code}}</td>
                                <td class="text-left" ng-show="apprl.onbehalof == '0'">{{apprl.employee_name}} -
                                    {{apprl.employee_code}}
                                </td>
                                <td class="text-left" ng-show="apprl.onbehalof != '0'">{{apprl.onbehalof_employeename}}
                                    - {{apprl.onbehalof_employeecode}}
                                </td>
                                <td class="text-center">{{apprl.apptype}}</td>
                                <td class="text-center">{{apprl.approveddate}}</td>
                                <td class="text-center">{{apprl.appcomment}}</td>
                                <td class="text-center">
                                    <p ng-show="apprl.status == 'PENDING' && apprl.applevel == '1' ">
                                        Tour Claim Submitted To Forwarder</p>
                                    <p ng-show="apprl.status == 'PENDING' && apprl.applevel == '2' ">
                                        Tour Claim Submitted To Approver</p>
                                    <p ng-show="apprl.status == 'REJECTED' && apprl.applevel == '1' ">
                                        Tour Claim Forwarder Rejected</p>
                                    <p ng-show="apprl.status == 'REJECTED' && apprl.applevel == '2' ">
                                        Tour Claim Approver Rejected</p>
                                    <p ng-show="apprl.status == 'APPROVED' && apprl.applevel == '1'">
                                        Tour Claim Forwarder Approved</p>
                                    <p ng-show="apprl.status == 'APPROVED' && apprl.applevel == '2'">
                                        Tour Claim Approver Approved</p>
                                    <p ng-show="apprl.status == 'REQUESTED'">
                                        Tour Claim Request Submitted</p>
                                    <p ng-show="apprl.status == 'RETURN' && apprl.applevel == '1'">
                                        Tour Claim Returned From Forwarder</p>
                                    <p ng-show="apprl.status == 'RETURN' && apprl.applevel == '2'">
                                        Tour Claim Returned From Approver</p>
                                </td>

                            </tr>
                            <tr ng-show="data_len ==  0">
                                <td class="warning" colspan="17">
                                    No Records Found.
                                </td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr>
                                <td colspan="7">
                                    <ul boundary-links="true" class="pagination-sm cust_pagination"
                                        items-per-page="itemsPerPage"
                                        max-size="maxSize"
                                        ng-model="currentPage" total-items="eClaim_tavels.length"
                                        uib-pagination></ul>
                                </td>
                                <!--                        <td class="text-left" colspan="1">-->
                                <!--                            <span>Total Count:<br/> <b class="text-centre"> {{eClaim_tavels.length}}</b></span>-->
                                <!--                        </td>-->
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!--ccbs popup-->
        <div aria-hidden="" aria-labelledby="exampleModalLabel"
             class="modal fade"
             data-backdrop="" data-keyboard="false"
             id="viewmodals">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <strong>CCBS</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="row">
                    </div>
                    <br/>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="col-md-3">
                                <b>Value: &#8377; {{total_approveamount}}</b>
                            </div>
                            <div class="col-md-3">
                                <b>Tour No : {{tour_no}}</b>
                            </div>
                        </div>
                    </div>
                    <form name="expense_valid" novalidate role="form">
                        <div class="body">
                            <div class="modal-body popup-body">
                                <div class="row">
                                    <div class="col-lg-12 col-sm-12">
                                        <div class="row table-responsive">
                                            <div class="col-md-12 col-lg-12 col-sm-12">
                                                <fieldset data-ng-repeat="choice in choices_ccbs">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <label>BS</label>
                                                            <md-autocomplete
                                                                    ng-required="true"
                                                                    md-clear-button="true"
                                                                    md-input-maxlength=126
                                                                    ng-disabled="choice.status == '1' || choice.status == '2'"
                                                                    md-item-text="item.bs_name"
                                                                    md-items="item in querySearchbs(choice.bsname)"
                                                                    md-min-length=0
                                                                    md-no-cache="true"
                                                                    md-search-text="choice.bsname"
                                                                    md-selected-item="choice.selectedbs"
                                                                    md-selected-item-change="bschange(item,choice)"
                                                                    placeholder="Select BS">
                                                                <md-item-template>
                                                                    <span md-highlight-text="searchTe">{{item.bs_name}} - {{item.bs_code}}  </span>
                                                                </md-item-template>
                                                                <md-not-found>
                                                                    No BS matching "{{searchTe}}" were found.
                                                                </md-not-found>
                                                            </md-autocomplete>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label>CC</label>
                                                            <md-autocomplete
                                                                    md-clear-button="true"
                                                                    md-input-maxlength=126
                                                                    md-item-text="item.cc_name"
                                                                    ng-disabled="choice.status == '1' || choice.status == '2'"
                                                                    md-items="item in querySearchcc(choice.ccname)"
                                                                    md-min-length=0
                                                                    md-no-cache="true"
                                                                    md-search-text="choice.ccname"
                                                                    md-selected-item="choice.selectedcc"
                                                                    md-selected-item-change="ccchange(item,choice)"
                                                                    placeholder="Select CC">
                                                                <md-item-template>
                                                                    <span md-highlight-text="searchTe">{{item.cc_name}} - {{item.cc_code}} </span>
                                                                </md-item-template>
                                                                <md-not-found>
                                                                    No CC matching "{{searchTe}}" were found.
                                                                </md-not-found>
                                                            </md-autocomplete>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <md-input-container class="md-block inputcontainer">
                                                                <label>Expense Amount</label>
                                                                <input type="text" ng-model="choice.amount"
                                                                       name="" ng-required="true"
                                                                       numbers-only
                                                                       ng-disabled="choice.status == '1' || choice.status == '2'"
                                                                       placeholder="Enter Expense Amount"
                                                                       ng-blur="percen_calc($index,choice.amount)">
                                                            </md-input-container>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <md-input-container class="md-block inputcontainer">
                                                                <label>Percentage</label>
                                                                <input type="text"
                                                                       ng-model="choice.percentage"
                                                                       ng-required="true"
                                                                       ng-disabled="choice.status == '1' || choice.status == '2'"
                                                                       name=""
                                                                       maxlength="3"
                                                                       min="1" max="100"
                                                                       numbers-only
                                                                       placeholder="Enter Percentage"
                                                                       ng-blur="amount_calc($index,choice.percentage)">
                                                            </md-input-container>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <md-button class="md-fab md-mini md-primary custbutton"
                                                                       ng-show="$last"
                                                                       ng-disabled="applevel == 1 || choice.status == '1' || choice.status == '2'"
                                                                       ng-click="removeChoice()">
                                                                <md-icon>close</md-icon>
                                                                <md-tooltip>Remove</md-tooltip>
                                                            </md-button>
                                                        </div>
                                                    </div>
                                                </fieldset>
                                            </div>
                                        </div>
                                        <md-button class="md-fab md-mini md-primary custbutton" ng-disabled="add_asset"
                                                   ng-click="addNewChoice()">
                                            <md-icon>add</md-icon>
                                            <md-tooltip>Create Asset</md-tooltip>
                                        </md-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-center">
                                <md-button  class="btn btn-info custbutton" ng-click="ccbs_update()"
                                           ng-disabled="expense_valid.$invalid">
                                    Submit
                                    <md-tooltip>Submit</md-tooltip>
                                </md-button>
                                <md-button class="md-raised" data-dismiss="modal">Back
                                    <md-tooltip>close</md-tooltip>
                                </md-button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endverbatim %}
<script>
var app = angular.module('dateapp', ['ngMaterial', 'ui.bootstrap', 'AppCommon', 'ngMessages'])
    .config(function($httpProvider) {
        $httpProvider.defaults.xsrfCookieName = 'csrftoken';
        $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
    });
app.controller('datectrl', function($scope,$sce,eclaimService,$http, $window, $mdDialog,$mdDateLocale, $rootScope, $filter) {
    $scope.orderByField = '';
    $scope.maxSize = 3;
    $scope.itemsPerPage = 10;
    $scope.currentPage = 1;
    $scope.remarks = false;
    $scope.reason = false;
    $scope.eClaim_approval = [];
    var detail = JSON.parse(sessionStorage.getItem('today'));
    var td = detail.date
    $scope.approvaldata = false;
    $scope.advanceadjust = false;
    $scope.cap_date = convertdate(td);

    var travel_data =JSON.parse(sessionStorage.getItem('eClaim_exp_aprl'));
    $scope.tour_gid = travel_data.tour_gid;
    $scope.tour_no = travel_data.tour_no;
    $scope.empgid = travel_data.empgid;
    $scope.approvalgid = travel_data.approvalgid;
    $scope.applevel = travel_data.applevel;
    $scope.appcomment = travel_data.appcomment;
    $scope.onbehalf_emp = travel_data.onbehalf_emp;
    $scope.comments = "";
    $scope.approval_show = false;
    if(travel_data.claimstatus == "APPROVED" && travel_data.applevel == 1 ){
        $scope.claimstatus = "ForwarderApproved";
        $scope.approval_show = true;
    }
    else{
        $scope.claimstatus = travel_data.claimstatus;
    }
    $scope.status_check = false;
    if($scope.applevel == 1){
        $scope.Approve_opt = true;
        $scope.Reject_opt = false;
        $scope.Higher_authority = false;
    }
    else  {
        $scope.Approve_opt = false;
        $scope.Reject_opt = false;
        $scope.Higher_authority = true;
    }

    $scope.move_other = function(){
        $scope.Approve_opt = true;
        $scope.Reject_opt = false;
        $scope.Higher_authority = false;
    }

    if($scope.claimstatus == 'RETURN' || $scope.claimstatus =='APPROVED'){
        $scope.Approve_opt = false;
        $scope.Reject_opt = false;
        $scope.Higher_authority = false;
    }

    $mdDateLocale.formatDate = function(date) {
            return $filter('date')(date, "dd-MMM-yyyy");
        };
    $scope.loading = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.body),
            clickOutsideToClose: false
        });
    };
    $scope.loading_popup = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.getElementById('viewmodals'))
        });
    };

    $scope.loading_popup_img = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.getElementById('attach_view')),
            clickOutsideToClose: false
        });
    };
    $scope.endloading = function() {
        $mdDialog.hide();
    };
    $scope.files =[];
    loadeclaim();
    function loadeclaim(){
        $scope.loading();
        var data = {
            params: {
                "Type": "CLAIMED_EXPENSE",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Claimrequest_Tourgid": $scope.tour_gid
                        }
                    }
                }
            }
        }
        var get_eclaim = eclaimService.ecalim_drop_get(data)
        get_eclaim.then(function(result) {
                $scope.main = result.data.DATA;
                $scope.files = result.data.FILE;
                $scope.eClaim_approval = $scope.main;
                if($scope.applevel == 1){
                    if(result.data.MESSAGE == "FOUND"){
                        if($scope.eClaim_approval[0].approvedby_fr != 0){
                            if($scope.claimstatus == "PENDING" && $scope.applevel == 1){
                                $scope.status_check = true;
                            }
                            $scope.searchbr = $scope.eClaim_approval[0].approver_branch;
                            $scope.searchemp = $scope.eClaim_approval[0].approver_name;
                            $scope.comments = $scope.eClaim_approval[0].appcomment_fr;
                        }
                    }
                }
                $scope.total_eligamount = 0;
                $scope.total_claimamount = 0;
                $scope.total_approveamount = 0;
                angular.forEach($scope.eClaim_approval, function(item1) {
                    $scope.total_eligamount = $scope.total_eligamount + item1.eligibleamount;
                    $scope.total_claimamount = $scope.total_claimamount + item1.claimedamount;
                    $scope.total_approveamount = $scope.total_approveamount + item1.approvedamount;
                    $scope.advanceamount = item1.advanceamount;
                });
                $scope.net_amount = $scope.total_approveamount - $scope.advanceamount;
                $scope.data_len = $scope.eClaim_approval.length;
                $scope.pageLength = $scope.eClaim_approval.length;
                $scope.Totalpages = Math.ceil($scope.eClaim_approval.length / $scope.itemsPerPage);
        }).finally($scope.endloading);
    }

    $scope.expense_view = function(e) {
        var eClaim_session = {
                tour_gid: e.claimrequest_gid
            };
        if(e.expsensecode =="TRVL"){
            session_data (e)
            $window.location.href = "eClaim/eclaim_travel_exp";
        }
        else if(e.expsensecode =="MISC"){
            session_data (e)
            $window.location.href = "eClaim/eclaim_miscelan_exp";
        }
        else if( e.expsensecode =="LODG" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_lodg_exp";
        }
        else if(e.expsensecode =="LCONV" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_loc_conv_exp";
        }
        else if(e.expsensecode =="INCDL" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_incidental_exp";
        }
        else if(e.expsensecode =="DLYDM" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_dailydiem_exp";
        }
        else if(e.expsensecode =="PCKG" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_pkg_mov_dt";
        }
    }

    function session_data (e){
        if($scope.claimstatus == "APPROVED" || $scope.applevel == 2 ){
            type = true;
        }
        else{
            type = false;
        }
        var eClaim_travel_ses = {
            claimreq_gid : e.claimreq_gid,
            gid:e.gid,
            description:e.description,
            expsensecode:e.expsensecode,
            expensegid:e.gid,
            requestorcomment:e.requestorcomment,
            approve:type,
            applevel:$scope.applevel,
            exp_add:false,
        }
        $scope.tavel_data=[];
        $scope.tavel_data.push(eClaim_travel_ses);
        sessionStorage.setItem('eClaim_tavel', JSON.stringify($scope.tavel_data));
    }
<!--    loadbranch();-->
    function loadbranch(){
        var data = {
            params: {
                "Type": "GET_BRANCH",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Limit_Start":0,
                             "Limit_End":30,
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.get_branch_data = $scope.main;
        });
    }

    $scope.advanceadjust_data = [];
    advance_adjust();
    function advance_adjust(){
        var data = {
            params: {
                "Type": "AP_ADVANCE",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "TourGid":$scope.tour_gid,
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.advanceadjust_data = $scope.main;
            if(result.data.MESSAGE != "NOT_FOUND" || result.data.MESSAGE != "ERROR_OCCURED"){
                $scope.advanceadjust_data = $scope.main;
<!--                angular.forEach($scope.advanceadjust_data, function(item1) {-->
<!--                    item1.adjustamount = '';-->
<!--                });-->
                $scope.advanceadjust = true;
            }
            else {
                $scope.advanceadjust = false;

            }
        });
    }

    $scope.brsearch = gotobranch;
        function gotobranch(query) {
             if(query == "undefined"){
                query = "";
            }
            var datas = {
                params: {
                    "Type": "GET_BRANCH",
                    "json" : {
                        "Params": {
                            "FILTER": {
                                "Limit_Start":0,
                                "Limit_End":30,
                                "branch_name":"",
                                "branch_code":"",
                                "branch_detail":query
                            }
                        }
                    }
                }
            }
             return $http.get(Appname + '/eclaim_dropdata/' , datas).then(function(data) {
                var final_values=data.data.DATA;
<!--                console.log(final_values);-->
                return final_values;
             });
    }

    $scope.branchchange = function(v){
        var data = {
            params: {
                "Type": "APPROVER_LIST",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Branch_Gid":v.branch_gid,
                            "App_Type":"CLAIM"
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.get_employee_data = $scope.main;
        });
    }
    $scope.empsearch = gotoemp;
        function gotoemp(query) {
            var result = $filter('filter')($scope.get_employee_data, {
                'employee_name': query
            });
            return result;
    }

    $scope.direct_approve = function() {
        if($scope.CCBS.length !=0){
            $scope.validation = "True";
            var sum = 0;
            $scope.claimamount = $scope.total_approveamount;
            angular.forEach($scope.CCBS, function(item2) {
                sum = sum + item2.amount;
            });
            if (sum != parseInt($scope.claimamount)){
                $scope.validation = "False";
            }
            if($scope.validation == "True" ){
                $scope.loading();
                 var data = {
                  "gid":$scope.approvalgid,
                  "tourgid":$scope.tour_gid,
                  "approvedby":0,
                  "appcomment":$scope.comments,
                  "applevel":2,
                  "apptype":"CLAIM"
                }
                approve_data(data)
            }
            else{
                alert("CCBS Amount not matched");
            }
        }
        else{
            alert("CCBS Missing")
        }
    }

    $scope.move_approve = function() {
        if($scope.eClaim_approval[0].approvedby_fr == 0){
            $scope.loading();
                var data = {
                          "gid":$scope.approvalgid,
                          "tourgid":$scope.tour_gid,
                          "approvedby":$scope.selectedemp.employee_gid,
                          "appcomment":$scope.comments,
                          "applevel":2,
                          "apptype":"CLAIM"
                }
                approve_data(data)
        }
        else{
            alert("Cannot Submit...")
        }
    }

    function approve_data(datas){
        var data = {
            params: {
                "Type": "MOVE_APPROVE_II",
                "json" : {
                    "Params": {
                        "DETAILS": datas
                    }
                }
            }
        }
        save_file(data);
    }

    function save_file(data) {
        var eclaim_daily = eclaimService.ecalim_data(data);
        eclaim_daily.then(function(result) {
            $scope.set_msg = result.data.MESSAGE
            if($scope.set_msg == 'SUCCESS' ){
                success_toast();
                $window.location.href = "eClaim/eclaim_expense_approval";
            }
            else{
                alert($scope.set_msg);
            }
        }).finally($scope.endloading);
   }

    $scope.attachment = function(){
         $scope.loading_popup_img();
         if($scope.files.length != 0){
            angular.forEach($scope.files, function(item1) {
                var name = item1.file_name.split('.');
                if(name[1] == "pdf"){
                    complete_url ='http://docs.google.com/gview?url=' + encodeURIComponent(item1.file_path) + '&embedded=true';
                    //Using a function of the library $sce called trustAsResourceUrl()
                    item1.file_path = $sce.trustAsResourceUrl(complete_url);
                    item1.type = "pdf";
                }
                else{
                    item1.type = "image";
                }
            });

         }
         else{
            alert("No Document..");
         }
         $scope.endloading();
         var model = modalshow('attach_view');
    }

    $scope.move_reject = function(){
        $scope.Approve_opt = false;
        $scope.Reject_opt = true;
    }
    $scope.close_reject = function(){
        $scope.Approve_opt = true;
        $scope.Reject_opt = false;
        $scope.return_reason = false;
        $scope.comments = "";
    }
    $scope.close_return = function(){
        $scope.Approve_opt = true;
        $scope.Reject_opt = false;
        $scope.return_reason = false;
        $scope.comments = "";
    }

    $scope.return = function() {
         $scope.return_reason = true;
         $scope.Approve_opt = false;
    };
    $scope.direct_return = function(){
        $scope.loading();
        var data = {
            params: {
                "Type": "ECLAIM_RETURN",
                "json" : {
                    "Params": {
                        "DETAILS": {
                          "gid":$scope.approvalgid,
                          "tourgid":$scope.tour_gid,
                          "appcomment":$scope.comments,
                          "apptype":"CLAIM"
                        },
                    }
                }
            }
        }
        save_file(data);
        $scope.Approve_opt = true;
        $scope.reject_reason = false;

     }

    $scope.reject_expense = function(){
        $scope.loading();
        var data = {
            params: {
                "Type": "MOVE_REJECT",
                "json" : {
                    "Params": {
                        "DETAILS": {
                          "gid":$scope.approvalgid,
                          "tourgid":$scope.tour_gid,
                          "appcomment":$scope.comments,
                          "apptype":"CLAIM"
                        },
                    }
                }
            }
        }
        save_file(data);
    }

    $scope.get_approval_data = [];
    loadapprovalflow();
    function loadapprovalflow(){
        var data = {
            params: {
                "Type": "APPROVAL_FLOW",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "TourGid":$scope.tour_gid,
                            "AppType":"CLAIM"
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            if(result.data.MESSAGE != "NOT_FOUND" ){
                $scope.get_approval_data = $scope.main;
                $scope.approvaldata = true;
            }
            else {
                $scope.approvaldata = false;
            }
        });
    }

    $scope.CCBS = [];
    ccbs_data();
    function ccbs_data(){
        var data = {
            params: {
                "Type": "CCBS_GET",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Tour_Gid":$scope.tour_gid,
                            "CCBS_Type":"2"
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            if(result.data.MESSAGE == "NOT_FOUND" ){
                $scope.CCBS = [];
            }
            else{
                $scope.CCBS = $scope.main;
                angular.forEach($scope.advance_details, function(item1) {
                    angular.forEach($scope.CCBS, function(item2) {
                        if (item1.gid == item2.claimreqgid){
                            item2.status = item1.status
                        }
                    });
                });
            }
        });
    }

    $scope.arr_index = '';
    $scope.add_asset = false;
    $scope.add_ccbs = function(){
        $scope.choices_ccbs = [];
        if($scope.itnary_amount != 0){
            $scope.claimamount = $scope.total_approveamount;
            if($scope.CCBS.length == 0){
                $scope.choices_ccbs = [{
                gid:0,
                claimreqgid:0,
                amount:"",
                percentage:""}];
                modalshow('viewmodals');
            }
            else{
                angular.forEach($scope.CCBS, function(item2) {
                    $scope.choices_ccbs.push(item2);
                });
                modalshow('viewmodals');
            }
        }
    }

    bsdata();
    function bsdata(){
        var data = {
            params: {
                "Type": "BS",
                "json" : {

                    }
                }
            }
        var get_bs_data = eclaimService.ecalim_drop_get(data)
            get_bs_data.then(function(result) {
                $scope.main = result.data.DATA;
                $scope.get_bs = $scope.main;
            })
    }
    $scope.querySearchcc = gotocc;
    function gotocc(query) {
        var result = $filter('filter')($scope.get_cc, {
            'cc_name': query
        });
        return result;
    }

    $scope.ccchange = function(cc,choice){
        choice.ccgid = cc.cc_gid;
    }
    $scope.bschange = function(bs,choice){
        var data = {
            params: {
                "Type": "CC",
                "json" : {
                    "Bs_gid": bs.bs_gid
                    }
                }
            }
        var get_cc_data = eclaimService.ecalim_drop_get(data)
        get_cc_data.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.get_cc = $scope.main;
            choice.bsgid = bs.bs_gid;
        })
        return $scope.get_cc;
    }

    $scope.querySearchbs = gotobs;
    function gotobs(query) {
        var result = $filter('filter')($scope.get_bs, {
            'bs_name': query
        });
        return result;
    }

    $scope.percen_calc = function(i,v){
        var value = (v / $scope.claimamount)*100;
        $scope.choices_ccbs[i].percentage = value;
    }

    $scope.amount_calc = function(i,v){
        var value = (v /100)* $scope.claimamount;
        $scope.choices_ccbs[i].amount = value;
    }
    $scope.removeChoice = function() {
        var lastItem = $scope.choices.length-1;
        $scope.choices_ccbs.splice(lastItem);
        $scope.add_asset = false;
    };
    $scope.addNewChoice = function() {
        var sum = 0;
<!--        for (i = 0; i < $scope.choices_ccbs.length; i++) {-->
<!--            sum = parseFloat(sum) + parseFloat($scope.choices_ccbs[i].amount);-->
<!--        }-->
        angular.forEach($scope.choices_ccbs, function(item) {
            if(item.status !=2 && item.status !=1){
                sum = parseFloat(sum) + parseFloat(item.amount);
            }
        });
            if( sum ==0 ){
                var len = $scope.advance_details.length -1
                if($scope.advance_details[len].gid =="0"){
                    var newItemNo = $scope.choices_ccbs.length+1;
                    $scope.len_asset = $scope.len_asset + 1;
                    $scope.choices_ccbs.push({
                    gid:0,
                    claimreqgid:0,
                    amount:"",
                    percentage:""});
                }
                else{

                }
            }
            else if (sum > $scope.claimamount){
                $scope.add_asset = true;
                var len = $scope.choices_ccbs.length - 1;
                $scope.choices_ccbs[len].amount ="";
                $scope.choices_ccbs[len].percentage ="";
                warning_toast(not_matched,time_toast);
            }
            else if(sum < $scope.claimamount){
                var newItemNo = $scope.choices_ccbs.length+1;
                $scope.len_asset = $scope.len_asset + 1;
                $scope.choices_ccbs.push({
                gid:0,
                claimreqgid:0,
                amount:"",
                percentage:""});
            }
            else if(sum == $scope.claimamount){
                $scope.enable_update = false;
                $scope.reason = true;
            }
            else {
               error_toast(no_data,time_toast);
            }
    };

    $scope.ccbs_save = function(){
        var sum = 0;
        angular.forEach($scope.choices_ccbs, function(item) {
            if(item.status !=2 && item.status !=1){
                sum = parseFloat(sum) + parseFloat(item.amount);
            }
        });
            if (sum == $scope.claimamount){
                $scope.CCBS = [];
                angular.forEach($scope.choices_ccbs, function(item1) {
                    if (item1.status !=2 || item1.status !=1 ){
                        var data = {
                            "gid":item1.gid,
                            "type":"2",
                            "ccgid":item1.ccgid,
                            "bsgid":item1.bsgid,
                            "percentage":item1.percentage,
                            "claimreqgid":item1.claimreqgid,
                            "amount":item1.amount
                        }
                    }

                     $scope.CCBS.push(data);
                });
                success_toast();
                modalhide('viewmodals');
            }
            else{
                error_toast(no_data,time_toast);
            }
    }
    $scope.ccbs_update = function(){
        var sum = 0;
        angular.forEach($scope.choices_ccbs, function(item) {
            if(item.status !=2 && item.status !=1){
                sum = parseFloat(sum) + parseFloat(item.amount);
            }
        });
            if (sum == $scope.claimamount){
                $scope.CCBS = [];
                angular.forEach($scope.choices_ccbs, function(item1) {
                    if (item1.status !=2 || item1.status !=1 ){
                        var data = {
                            "ccbsgid":item1.gid,
                            "tour_gid":$scope.tour_gid,
                            "ccbs_type":"2",
                            "ccgid":item1.ccgid,
                            "bsgid":item1.bsgid,
                            "percentage":item1.percentage,
                            "claimreqgid":item1.claimreqgid,
                            "amount":item1.amount
                        }
                    }
                     $scope.CCBS.push(data);
                });
                var data = {
                    params: {
                        "Type": "CCBS_SET",
                        "json" : {
                            "Params": {
                                "CCBS": $scope.CCBS
                            }
                        }
                    }
                }
                $scope.loading_popup();
                var eclaim_daily = eclaimService.ecalim_data(data);
                eclaim_daily.then(function(result) {
                    $scope.set_msg = result.data.MESSAGE
                    if($scope.set_msg == 'SUCCESS' ){
                        success_toast();
                        modalhide('viewmodals');
                        $window.location.reload();
                    }
                    else{
                        alert($scope.set_msg);
                    }
                }).finally($scope.endloading);
            }
            else{
                error_toast(no_data,time_toast);
            }
    }

});

app.service('eclaimService', function($http) {

    this.ecalim_data = function(data) {
        var response = $http.post(Appname + "/eclaim_process_set/",data);
        return response;
    }
    this.ecalim_drop_get = function(data) {
        var response = $http.get(Appname + "/eclaim_dropdata/",data);
        return response;
    }

});





</script>
{% endblock %}
