{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %}Prepare Payment {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}
<div class="maincontent">
    <div ng-app="makersummary" ng-controller="ctrlsummary" class="container container1" ng-cloak>
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>Prepare Payment</h4>
            </div>
        </div>
        <div class="row">
            <form role="form" name="inwardsummary_valid">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-3 col-lg-3 col-sm-3">
                            <md-input-container class="md-block inputcontainer">
                                <label>CR No</label>
                                <input ng-model="invoiceheader_crno"
                                       ng-change="ACselectchange(selectedtype,supplier_name,invoicenum,invoiceamt,from_date,invoiceheader_crno)"/>
                            </md-input-container>
                        </div>
                        <div class="col-md-3 col-lg-3 col-sm-3">
                            <md-input-container class="md-block inputcontainer">
                                <label>Invoice Type</label>
                                <md-select ng-model="selectedtype" multiple="">
                                    <md-optgroup label="Invocie Types">
                                        <md-option ng-value="invoice.metadata_value"
                                                   ng-repeat="invoice in Invoice_Types"
                                        >
                                            {{invoice.metadata_value}}
                                        </md-option>
                                    </md-optgroup>
                                </md-select>
                            </md-input-container>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-3">
                            <md-input-container class="md-block inputcontainer" ng-hide="hide">
                                <label> Supplier Name</label>
                                <input type="text" ng-model="supplier_name"
                                       ng-change="ACselectchange(selectedtype,supplier_name,invoicenum,invoiceamt,from_date,crno)"
                                       maxlength="16">
                            </md-input-container>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-3">
                            <md-autocomplete
                                    ng-disabled="ECFcheckboxModel.value"
                                    md-clear-button="true" md-floating-label="Branch"
                                    md-input-maxlength=126
                                    md-item-text="item.branch_detail"
                                    md-items="item in get_branch(searchbrancheName)"
                                    md-selected-item-change="branchNameChanged(item)"
                                    md-min-length=0 md-search-text="searchbrancheName"
                                    ng-model="itemss" md-no-cache="true" size="5"
                                    md-selected-item="selected_branch">
                                <md-item-template>
                                    <span md-highlight-text="searchbrancheName"> {{item.branch_detail}}</span>
                                </md-item-template>
                                <md-not-found>
                                    No Branch Name matching "{{search Branch Name}}"
                                    were
                                    found.
                                </md-not-found>
                            </md-autocomplete>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-3 col-lg-3 col-sm-3">
                            <md-input-container class="md-block inputcontainer">
                                <label>Invoice Number</label>
                                <input ng-model="invoicenum"
                                       ng-change="ACselectchange(selectedtype,supplier_name,invoicenum,invoiceamt,from_date,crno)"
                                />
                            </md-input-container>
                        </div>
                        <div class="col-md-3 col-lg-3 col-sm-3">
                            <md-input-container class="md-block inputcontainer">
                                <label>Invoice Amount</label>
                                <input ng-model="invoiceamt"
                                       ng-change="ACselectchange(selectedtype,supplier_name,invoicenum,invoiceamt,from_date,crno)"
                                       numbers-only maxlength="10"/>
                            </md-input-container>
                        </div>
                        <div class="col-md-3 col-lg-3 col-sm-3">
                            <md-input-container class="md-block inputcontainer">
                                <label>From Date</label>
                                <md-datepicker md-hide-icons="calendar"
                                               ng-model="from_date"
                                               md-hide-icons="calendar"
                                               ng-change="ACselectchange(selectedtype,supplier_name,invoicenum,invoiceamt,from_date,crno)"
                                               md-min-date="maxDate"
                                               md-max-date="minDate" formatDate></md-datepicker>
                            </md-input-container>
                        </div>
                        <div class="col-md-3 col-lg-3 col-sm-3">
                            <md-input-container class="md-block inputcontainer">
                                <label> To Date</label>
                                <md-datepicker md-hide-icons="calendar"
                                               ng-model="to_date"
                                               md-hide-icons="calendar"
                                               ng-change="ACselectchange(selectedtype,supplier_name,invoicenum,invoiceamt,from_date,crno)"
                                               md-min-date="maxDate"
                                               md-max-date="minDate" formatDate></md-datepicker>
                            </md-input-container>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="col-md-9"></div>
                    <!--                    <div class="col-md-1">-->
                    <!--                        <md-button class="md-fab md-mini md-primary custbutton"-->
                    <!--                                   href="get_Accounting_Entry_Data?action=GET&type=AP_INVOICEHEADER_GET&invoiceheader_crno={{invoiceheader_crno}}&selectedtype={{selectedtype}}&status={{status}}&supplier_name={{supplier_name}}&branch_gid={{branch_gid}}&invoicenum={{invoicenum}}&invoiceamt={{invoiceamt}}&from_date={{from_date}}&to_date={{to_date}}">-->
                    <!--                            <md-icon>get_app</md-icon>-->
                    <!--                            <md-tooltip>Download XL</md-tooltip>-->
                    <!--                        </md-button>-->
                    <!--                    </div>-->
                    <div class="col-md-1">
                        <md-button class="md-fab md-mini md-primary custbutton"
                                   ng-click="find_maker_summary()">
                            <md-icon>search</md-icon>
                            <md-tooltip>Search</md-tooltip>
                        </md-button>
                    </div>
                    <div class="col-md-1">
                        <md-button class="md-fab md-mini md-warn"
                                   ng-click="clear_seach()">
                            <md-icon>search_off</md-icon>
                            <md-tooltip>Clear Search</md-tooltip>
                        </md-button>
                    </div>
                </div>
            </form>
        </div>
        <div class="row table-responsive">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                       md-progress="deferred">
                    <thead class="header">
                    <tr style="text-align:center">
                        <th>S.No</th>
                        <th>CR No</th>
                        <th>Invoice Type</th>
                        <th>Supplier Name</th>
                        <th>Employee Name</th>
                        <th>Invoice No</th>
                        <th>Invoice Date</th>
                        <th>Updated Date</th>
                        <th>Invoice Credit Amount</th>
                        <th>Invoice Amount</th>
                        <th>Suspense Amont</th>
                        <th>Status</th>
                        <th><br/>
                            <md-checkbox ng-model="select_all_bulk" ng-class="md-warn"
                                         ng-true-value="'false'"
                                         ng-false-value="'true'"
                                         checked="false"
                                         ng-disabled="true"
                                         ng-click="select_all('bulk',select_all_bulk)"
                                         type="checkbox">Bulk
                            </md-checkbox>
                        </th>
                        <!--                        <th><br/>-->
                        <!--                            <md-checkbox ng-model="select_all_neting" ng-class="md-warn"-->
                        <!--                                         ng-true-value="'false'"-->
                        <!--                                         ng-false-value="'true'"-->
                        <!--                                         checked="false"-->
                        <!--                                         ng-click="select_all('neting',select_all_neting)"-->
                        <!--                                         type="checkbox">Neting-->
                        <!--                            </md-checkbox>-->
                        <!--                        </th>-->
                        <th>
                            Netting
                        </th>

                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="sum in maker_summary">
                        <td class="text-center" ng-model="dept_name">
                            {{((currentPage-1)*itemsPerPage)+$index+1}}
                        </td>
                        <td ng-click="bilentry_data(sum)"><a href="">
                            {{sum.invoiceheader_crno}}</a>
                        </td>
                        <td>
                            {{sum.invoiceheader_invoicetype}}
                        </td>
                        <td>
                            {{sum.supplier_branchname}}
                        </td>
                        <td>
                            {{sum.employee_name}}
                        </td>
                        <td>{{sum.invoiceheader_invoiceno}}</td>
                        <td>{{sum.invoiceheader_invoicedate_full | date:'dd-MMM-yyyy'}}</td>
                        <td>{{sum.update_date | date:'dd-MMM-yyyy'}}</td>
                        <td align="right">{{sum.credit_amount}}</td>
                        <td align="right">{{sum.invoiceheader_amount}}</td>
                        <td align="right">{{sum.crditgl_amt}}</td>
                        <td>{{sum.invoiceheader_status}}</td>
                        <td align="center">
                            <md-checkbox ng-model="sum.bulk_selected" ng-class="md-warn"
                                         ng-true-value="'true'"
                                         ng-false-value="'false'"
                                         ng-change="change_invoice(sum,sum.bulk_selected,'bulk')"
                                         type="checkbox">
                            </md-checkbox>
                        </td>
                        <td align="center">
                            <md-checkbox ng-model="sum.neting_selected" ng-class="md-warn"
                                         ng-true-value="'true'"
                                         ng-false-value="'false'"
                                         ng-change="change_invoice(sum,sum.neting_selected,'neting')"
                                         type="checkbox">
                            </md-checkbox>
                        </td>
                    </tr>
                    <tr ng-show="maker_summary.length ==  0">
                        <td class="warning" colspan="14">
                            No Records Found.
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="8">
                            <ul uib-pagination total-items="Total_Row" ng-model="currentPage"
                                max-size="maxSize" ng-change="pageChanged()"
                                class="pagination-sm" boundary-links="true" items-per-page="itemsPerPage"></ul>
                        </td>
                        <td colspan="2">
                            <label>Page Count:</label>
                            <select type="text" style="width:100px;"
                                    class="form-control" placeholder="count"
                                    ng-model="itemsPerPage" ng-change="pageChanged()">
                                <option ng-value="10">10</option>
                                <option ng-value="20">20</option>
                                <option ng-value="50">50</option>
                                <option ng-value="100">100</option>
                                <option ng-value="150">150</option>
                                <option ng-value="200">200</option>
                                <option ng-value="300">300</option>
                                <option ng-value="500">500</option>
                            </select>
                        </td>
                        <td colspan="4">
                            <strong ng-hide="!total_row_execute">Total Count:{{Total_Row}}</strong>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4"></div>
            <div class="col-md-4">
                <md-button class="md-raised md-warn"
                           ng-click="approv_set('bulk')">PREPARE PAYMENT
                </md-button>
            </div>
            <!--            <div class="col-md-4">-->
            <!--                <md-button class="md-raised md-primary"-->
            <!--                           ng-click="approv_set('neting')">PREPARE PAYMENT FOR NETTING-->
            <!--                </md-button>-->
            <!--            </div>-->
        </div>

        <div class="modal fade" id="view_prepare_payment_data" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:80%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="exampleModalLabel">
                            Payment Data
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <div class="row table-responsive">
                                <div class="col-md-12 col-lg-12 col-sm-12">
                                    <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                           md-progress="deferred">
                                        <thead class="header">
                                        <tr style="text-align:center">
                                            <th>S.No</th>
                                            <th>CR No</th>
                                            <th>Paymode Name</th>
                                            <th>Invoice Type</th>
                                            <th>Supplier Name</th>
                                            <th>Employee Name</th>
                                            <th>Bank Name</th>
                                            <th>Bank Account Number</th>
                                            <th>Branch IFSC Code</th>
                                            <th>Beneficiary Name</th>
                                            <th>Invoice No</th>
                                            <th>Invoice Date</th>
                                            <th>Invoice Credit Amount</th>
                                            <th>Invoice Amount</th>
                                            <th>Amount To Pay</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr ng-repeat="sums in final_prepare_payment_data.slice(((currentPages-1)*itemsPerPages),((currentPages)*itemsPerPages)) | filter:search:strict">
                                            <td class="text-center">
                                                {{((currentPages-1)*itemsPerPages)+$index+1}}
                                            </td>
                                            <td> {{sums.invoiceheader_crno}}</td>
                                            <td> {{sums.paymode_name}}</td>
                                            <td> {{sums.invoiceheader_invoicetype}}</td>
                                            <td> {{sums.supplier_branchname}}</td>
                                            <td> {{sums.employee_name}}</td>
                                            <td> {{sums.bank_name}}</td>
                                            <td> {{sums.bankdetails_acno}}</td>
                                            <td> {{sums.bankbranch_ifsccode}}</td>
                                            <td> {{sums.bankdetails_beneficiaryname}}</td>
                                            <td>{{sums.invoiceheader_invoiceno}}</td>
                                            <td>{{sums.invoiceheader_invoicedate_full | date:'dd-MMM-yyyy'}}</td>
                                            <td align="right">{{sums.credit_amount}}</td>
                                            <td align="right">{{sums.invoiceheader_amount}}</td>
                                            <td align="right"><input valid-number class="textboxgeneral" maxlength="16"
                                                                     ng-init="sums.Amt_topay =(sums.credit_amount - sums.paydetail_amt)"
                                                                     ng-change="Amt_partial(sums)"
                                                                     ng-model="sums.Amt_topay" disabled

                                            /></td>
                                            <span style="display: none;">Total: {{ getPaymentTo_pay() }}</span>
                                        </tr>
                                        </tbody>
                                        <tfoot>
                                        <tr>

                                            <td colspan="11">
                                                <ul uib-pagination total-items="final_prepare_payment_data.length"
                                                    ng-model="currentPages"
                                                    max-size="maxSizes"
                                                    class="pagination-sm" boundary-links="true"
                                                    items-per-page="itemsPerPages"></ul>
                                            </td>

                                            <td colspan="2" style="padding: 20px">
                                                <strong>Total Count:{{final_prepare_payment_data.length}}</strong>
                                            </td>
                                            <td colspan="2" style="padding: 20px">
                                                <strong>Total Amount:{{totalamount_topay}}</strong>

                                            </td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-4"></div>
                                    <div class="col-md-2">
                                        <md-button class="md-raised md-warn" value="close"
                                                   ng-click="save_Payment()" ng-disabled="approve_button==0"
                                                   aria-label="Close">Submit
                                        </md-button>
                                    </div>
                                    <div class="col-md-2">
                                        <md-button class="md-raised" value="close" data-dismiss="modal"
                                                   aria-label="Close">Cancel
                                        </md-button>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
            </form>
        </div>


    </div>
</div>
{% endverbatim %}
<script>
    var app=angular.module('makersummary',['ngMaterial','ui.bootstrap']).config(function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
});

app.run(function($mdDateLocale, $filter) {
    $mdDateLocale.formatDate = function(date) {
        return $filter('date')(date, "dd-MMM-yyyy");
    };
})

app.controller('ctrlsummary', ['$scope', '$filter', '$mdDateLocale', 'servicesummary', '$window', '$mdDialog', '$element','$http',
    function($scope, $filter, $mdDateLocale, servicesummary, $window, $mdDialog, $element,$http) {

        $element.find('input').on('keydown', function(ev) {
            ev.stopPropagation();
        });

        $scope.currentPage = 1;
        $scope.maxSize = 3;
        $scope.itemsPerPage = 10;

        $scope.currentPages = 1;
        $scope.maxSizes = 3;
        $scope.itemsPerPages = 10;
        $scope.maker_summary=[];

        $scope.selectedtype=[];
        $scope.status = ["APPROVED"];

        $scope.airwayno = '';
        $scope.courier = '';
        $scope.Summarydate = '';
        $scope.from_date = "";
        $scope.approve_button=1;
        $scope.ls_followup_date = new Date();

        var detail = JSON.parse(sessionStorage.getItem('today'));
        var td = detail.date;
        var employee_gid = detail.employee_gid;


        $scope.minDate = new Date(
            $scope.ls_followup_date.getFullYear(),
            $scope.ls_followup_date.getMonth(),
            $scope.ls_followup_date.getDate()
        );

        $scope.loading = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.body),
                clickOutsideToClose: false
            });
        };

        $scope.loading_popup = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.getElementById('view_prepare_payment_data')),
                clickOutsideToClose: false
            });
        };

        $scope.endloading = function() {
            $mdDialog.hide();
        };



        $scope.getPaymentTo_pay = function(){
         var sum = 0;
            var value = $scope.final_prepare_payment_data;
            for (var i = 0; i < value.length; i++) {
                if (value[i].Amt_topay !== undefined && value[i].Amt_topay !== "" ) {
                    sum += parseFloat(value[i].Amt_topay);
                }
            }
            $scope.totalamount_topay =parseFloat(sum).toFixed(2);;
            return $scope.totalamount_topay;

        }

        $scope.Amt_partial = function(payment_valid){

            if (parseFloat(payment_valid.Amt_topay) <= payment_valid.credit_amount  ) {


             } else {

                alert("Amount to pay should be less than Or equal to total amount")
                payment_valid.Amt_topay = ''
             }
        }

        $scope.total_row_execute=0;
        $scope.pageChanged = function(){
             if($scope.total_row_execute==0){
                $scope.total_row_execute=1;
                $scope.get_total_row_prepare_payment_summary();
            }
             if($scope.maker_summary.length==0){
                $scope.currentPage=1;
             }
             summary();
        }
        $scope.find_maker_summary=function(){
            $scope.Total_Row=0;
             $scope.total_row_execute=0;
            $scope.currentPage=1;
            summary();

        }

        summary();
        $scope.selected_branch="";
        function summary() {
        debugger;
            $scope.select_all_bulk="true";
            $scope.select_all_neting="true";
            $scope.nesting_data=[];
            $scope.checked_bulk_data=[];

            $scope.branch_gid="";
            if($scope.selected_branch!=undefined){
                $scope.branch_gid=$scope.selected_branch.branch_gid;
            }

            $scope.send_invoice_type=$scope.selectedtype.join();
            $scope.from_date=$filter('date')($scope.from_date,"yyyy-MM-dd");
            $scope.to_date=$filter('date')($scope.to_date,"yyyy-MM-dd");

            var datas={params:{"action":"GET","type":"AP_CREDIT_AMOUNT",
            "filter":{"InvoiceHeader_Status": "APPROVED,AMOUNT TRAN", "InvoiceHeader_Gid": "",
            "InvoiceHeader_InvoiceType": $scope.send_invoice_type,
            "InvoiceHeader_InvoiceDate":"","fromdate":$scope.from_date,"todate":$scope.to_date,"invoiceheader_branchgid":$scope.branch_gid,
            "InvoiceHeader_CRNo":$scope.invoiceheader_crno,
            "InvoiceHeader_InvoiceNo": $scope.invoicenum,"InvoiceHeader_Amount": $scope.invoiceamt,
            "Supplier_Name":$scope.supplier_name,
             "Page_Index": $scope.currentPage-1, "Page_Size": $scope.itemsPerPage}}};
            $scope.loading();
            var summary = servicesummary.get_ecf_maker_summary(datas);
            summary.then(function(result) {
                    $scope.maker_summary = result.data;
                    $scope.maintable = result.data;
                    if($scope.total_row_execute==0){
                        $scope.Total_Row=($scope.maker_summary.length)+($scope.currentPage*10);
                    }
                    for(var s=0;s<$scope.maker_summary.length;s++){
                        $scope.maker_summary[s].bulk_selected=false;
                        $scope.maker_summary[s].neting_selected=false;
                    }
                    console.log($scope.maker_summary);
                },
                function(err) {
                    alert('No data!.');
                }).finally($scope.endloading);
        }

        $scope.ACselectchange = function(selectedtype, supplier_name, invoicenum, invoiceamt, from_date,invoiceheader_crno) {
            $scope.ddMMyyyy = $filter('date')($scope.from_date, 'dd-MM-yyyy');
            $scope.maker_summary = $filter('filter')($scope.maintable, {
                "supplier_branchname": $scope.supplier_name,
                "invoiceheader_invoiceno":$scope.invoicenum,
                "invoiceheader_amount": $scope.invoiceamt,
                "invoiceheader_invoicedate": $scope.ddMMyyyy,
                "invoiceheader_crno": $scope.invoiceheader_crno
            }, );
        }

        $scope.get_total_row_prepare_payment_summary=function() {
        debugger;
            $scope.select_all_bulk="true";
            $scope.select_all_neting="true";
            $scope.nesting_data=[];
            $scope.checked_bulk_data=[];

            $scope.branch_gid="";
            if($scope.selected_branch!=undefined){
                $scope.branch_gid=$scope.selected_branch.branch_gid;
            }

            $scope.send_invoice_type=$scope.selectedtype.join();
            $scope.from_date=$filter('date')($scope.from_date,"yyyy-MM-dd");
            $scope.to_date=$filter('date')($scope.to_date,"yyyy-MM-dd");

            var datas={params:{"action":"GET","type":"AP_CREDIT_AMOUNT_COUNT",
            "filter":{"InvoiceHeader_Status": "APPROVED,AMOUNT TRAN", "InvoiceHeader_Gid": "",
            "InvoiceHeader_InvoiceType": $scope.send_invoice_type,
            "InvoiceHeader_InvoiceDate":"","fromdate":$scope.from_date,"todate":$scope.to_date,"invoiceheader_branchgid":$scope.branch_gid,
            "InvoiceHeader_CRNo":$scope.invoiceheader_crno,
            "InvoiceHeader_InvoiceNo": $scope.invoicenum,"InvoiceHeader_Amount": $scope.invoiceamt,
            "Supplier_Name":$scope.supplier_name,
             "Page_Index": 0, "Page_Size": $scope.itemsPerPage}}};

            var summary = servicesummary.get_ecf_maker_summary(datas);
            summary.then(function(result) {
                    $scope.Total_Row=result.data[0].count;
                },
                function(err) {
                    alert('No data!.');
                }).finally($scope.endloading);
        }


        $scope.nesting_data=[];
        $scope.change_invoice=function(invoice,values,type){
            var header_gid=invoice.invoiceheader_gid;

            if(type=="bulk"){
                for(var k=0;k<$scope.maker_summary.length;k++){
                    if($scope.maker_summary[k].invoiceheader_gid==header_gid){
                        $scope.maker_summary[k].invoiceheader_gid.bulk_selected=values;
                    }
                    else{
                        $scope.maker_summary[k].bulk_selected=false;
                    }
                }
            }
            else if(type=="neting"){
                $scope.loading();
                if(values=="true"){
                    for(var s=0;s<$scope.maker_summary.length;s++){
                        if($scope.maker_summary[s].invoiceheader_gid==header_gid){
                            var f=verify_data(invoice);
                            if(f==1){
                                //multiple neting
                                    //$scope.nesting_data.push($scope.maker_summary[s]);
                                    //$scope.maker_summary[s].invoiceheader_gid.bulk_selected=values;
                                //mutliole neting end
                                //Single neting
                                $scope.nesting_data=[];
                                for(var k=0;k<$scope.maker_summary.length;k++){
                                    if($scope.maker_summary[k].invoiceheader_gid==header_gid){
                                        $scope.maker_summary[k].invoiceheader_gid.neting_selected=values;
                                        $scope.nesting_data.push($scope.maker_summary[k]);
                                    }
                                    else{
                                        $scope.maker_summary[k].neting_selected=false;
                                    }
                                }
                                //single neting end

                            }
                            else if(f==2){
                               alert("Multiple Supplier Not Allowed!...");
                               $scope.maker_summary[s].neting_selected=false;
                            }
                            else if(f==3){
                               alert("Multiple Account Number Not Allowed!...");
                               $scope.maker_summary[s].neting_selected=false;
                            }
                            else if(f==4){
                                alert("Multiple Invoice Type Not Allowed!...");
                                $scope.maker_summary[s].neting_selected=false;
                            }
                            else if(f==0){
                                alert("Invalid Invoice Type");
                                $scope.maker_summary[s].neting_selected=false;
                            }
                        }
                    }
                }
                else if(values=="false"){
                    for(var a=0;b<$scope.maker_summary.length;b++){
                        if($scope.maker_summary[b].invoiceheader_gid==header_gid){
                            $scope.maker_summary[b].invoiceheader_gid.neting_selected=values;
                        }
                    }
                    for(var b=0;b<$scope.nesting_data.length;b++){
                        if($scope.nesting_data[b].invoiceheader_gid==header_gid){
                            $scope.nesting_data[b].neting_selected=values;
                            $scope.nesting_data.splice(b,1);

                        }
                    }
                }
                $scope.endloading();
            }

        }
        function verify_data(invoice){
            $scope.invoice_type=invoice.invoiceheader_invoicetype;
            $scope.supplier_name=invoice.supplier_name;
            var count=1;
            if($scope.nesting_data.length!=0){
                if($scope.invoice_type=="Non PO" || $scope.invoice_type=="PO"){
                    if($scope.nesting_data[0].invoiceheader_invoicetype=="PO" || $scope.nesting_data[0].invoiceheader_invoicetype=="Non PO"){
                        for(var q=0;q<$scope.nesting_data.length;q++){
                            if($scope.nesting_data[q].supplier_name!=$scope.supplier_name){
                                count=2;
                            }
                        }
                    }
                    else{
                        count=4;
                    }

                }
                else if($scope.invoice_type=="PETTYCASH"){
                    if($scope.nesting_data[0].invoiceheader_invoicetype==$scope.invoice_type){
                        count=1;
                    }
                    else{
                        count=4;
                    }
                }
                else if($scope.invoice_type=="AMORT"){
                    if($scope.nesting_data[0].invoiceheader_invoicetype==$scope.invoice_type){
                        count=1;
                    }
                    else{
                        count=4;
                    }
                }
                else if($scope.invoice_type=="BRANCH EXP"){
                    if($scope.nesting_data[0].invoiceheader_invoicetype==$scope.invoice_type){
                        for(var m=0;m<$scope.nesting_data.length;m++){
                            if($scope.nesting_data[m].supplier_name!=$scope.supplier_name){
                                count=2;
                            }
                        }
                    }
                    else{
                        count=4;
                    }
                }
                else{
                    count=0;
                }
            }
            else{
                if($scope.invoice_type=="AMORT" || $scope.invoice_type=="Non PO" || $scope.invoice_type=="PO" || $scope.invoice_type=="BRANCH EXP" || $scope.invoice_type=="PETTYCASH"){
                    count=1;
                }
                else{
                    count=0;
                }

            }
            if(count==1){
                return 1;
            }
            else if(count==2){
                return 2;
            }
            else if(count==3){
                return 3;
            }
            else if(count==4){
                return 4;
            }
            else if(count==0){
                return 0;
            }
        }

        $scope.select_all_bulk="true";
        $scope.select_all_neting="true";
        $scope.checked_neting_data=[];
        $scope.select_all=function(type,values){
            debugger;
            if(type=="bulk"){
                for(var m=0;m<$scope.maker_summary.length;m++){
                    $scope.maker_summary[m].bulk_selected=values;
                }
            }
            else if(type=="neting"){
                if($scope.checked_neting_data.length==0){
                    for(var n=0;n<$scope.maker_summary.length;n++){
                        $scope.maker_summary[n].neting_selected=values;
                        
                    }
                }
            }
        }

        $scope.approv_set=function(type){
            $scope.checked_bulk_data=[];
            $scope.final_prepare_payment_data=[];
            $scope.lock_status=0;
            debugger;
            if(type=="bulk"){
                $scope.loading();
                for(var k=0;k<$scope.maker_summary.length;k++){
                    if($scope.maker_summary[k].bulk_selected=="true"){
                        $scope.checked_bulk_data.push($scope.maker_summary[k]);
                    }
                }
                if($scope.checked_bulk_data.length!=0){
                    $scope.bulk_invoice_header_gids=[];
                    $scope.bulk_invoice_header_status=[];
                    $scope.single_invoice_status=$scope.checked_bulk_data[0].invoiceheader_status;
                    for(s=0;s<$scope.checked_bulk_data.length;s++){
                        $scope.bulk_invoice_header_gids.push($scope.checked_bulk_data[s].invoiceheader_gid)
                    }

                    //lock invoice
                    var datas={"action":'INSERT',"type":"AP_LOCK",
                        "filter":{"invoice_header_gid":$scope.bulk_invoice_header_gids[0],
                        "invoice_status":$scope.single_invoice_status}};
                    var get_lock_data = servicesummary.get_lock_data_service(datas);
                    get_lock_data.then(function(result) {
                        $scope.lock_data =result.data;
                        if($scope.lock_data[0]=="SUCCESS"){
                            var datas={params:{"action":"GET","type":"AP_PAYMENTDETAILS",
                                   "filter":{"InvoiceHeader_Status":$scope.single_invoice_status,"InvoiceHeader_Gid":$scope.bulk_invoice_header_gids,
                                   "InvoiceHeader_InvoiceDate": "", "fromdate": "", "invoiceheader_branchgid": "",
                                   "Page_Index": 0, "Page_Size": 10}}};
                            $scope.loading();
                            var summary = servicesummary.get_ecf_maker_summary(datas);
                            summary.then(function(result) {
                                    $scope.endloading();
                                   $scope.final_prepare_payment_data=result.data;
                                   console.log($scope.final_prepare_payment_data);
                                   modalshow('view_prepare_payment_data');
                                },
                                function(err) {
                                    alert('No data!.');
                                }).finally($scope.endloading);
                        }
                        else{
                            alert($scope.lock_data);
                        }

                    },
                    function(err) {
                        alert("Get Lock Details Is Issue");
                     }).finally($scope.endloading);




                }
                else{
                    alert("Select One Invoice");
                }
                $scope.endloading();

            }
            else if(type=="neting"){
                $scope.loading();
                if($scope.nesting_data.length!=0){
                    $scope.final_prepare_payment_data=$scope.nesting_data;
                    modalshow('view_prepare_payment_data');
                }
                else{
                    alert("Select One Invoice");
                }
                $scope.endloading();

            }

        }

        $scope.Search_click = function() {
            alert($scope.Summarydate);
            if ($scope.Summarydate != '') {
                var d = $scope.Summarydate;
                var curr_date = d.getDate();
                var curr_month = d.getMonth();
                curr_month++;
                var curr_year = d.getFullYear();
                Service_date = curr_year + "-" + curr_month + "-" + curr_date;
                alert(Service_date)
            }
            summary();
        }
        $scope.save_Payment = function() {
            debugger;
            $scope.approve_button=0;
            var header_json=[];
            var detail_json=[];
            var total_amounts=0;
            var new_paymode="";
            var new_paymode_gl="";
            var new_branch_name="";
            var new_bank_details_gid="";
            var new_account_number="";
            var new_ifsc_code="";
            var new_beneficiary_name="";

            for (var i = 0; i < $scope.final_prepare_payment_data.length; i++) {
                console.log($scope.final_prepare_payment_data[i])
                if ($scope.final_prepare_payment_data[i].invoiceheader_ppx == "E"   ) {
                       $scope.ref_id = $scope.final_prepare_payment_data[i].invoiceheader_employeegid;
                       $scope.header_type = "EMPLOYEE_PAYMENT";
                }else if($scope.final_prepare_payment_data[i].invoiceheader_ppx == "I" ){
                      $scope.ref_id = $scope.final_prepare_payment_data[i].invoiceheader_branchgid;
                         $scope.header_type = "BRANCH_PAYMENT";
                } else{
                     $scope.ref_id = $scope.final_prepare_payment_data[i].supplier_gid;
                        $scope.header_type = "SUPPLIER_PAYMENT";

                }
                total_amounts+=$scope.final_prepare_payment_data[i].Amt_topay;
                if($scope.final_prepare_payment_data[i].paymode_name!="CREDITGL"){
                    new_paymode=$scope.final_prepare_payment_data[i].paymode_name;
                    new_bank_details_gid=$scope.final_prepare_payment_data[i].credit_bankgid;
                    new_branch_name=$scope.final_prepare_payment_data[i].bankbranch_name;
                    new_account_number=$scope.final_prepare_payment_data[i].bankdetails_acno;
                    new_ifsc_code=$scope.final_prepare_payment_data[i].bankbranch_ifsccode;
                    new_beneficiary_name=$scope.final_prepare_payment_data[i].bankdetails_beneficiaryname;
                    new_paymode_gl=$scope.final_prepare_payment_data[i].paymode_glno;
                    new_paymode_credit_ddtranbranch=$scope.final_prepare_payment_data[i].credit_ddtranbranch;
                    new_paymode_credit_ddpaybranch=$scope.final_prepare_payment_data[i].credit_ddpaybranch;
                }


                detail_values=$scope.final_prepare_payment_data[i];

                detail_json.push(detail_values);

            }
            if(new_paymode=="" && $scope.final_prepare_payment_data.length>0){
                new_paymode="CREDITGL";
                new_bank_details_gid=0;
                new_branch_name="null";
                new_account_number="null";
                new_ifsc_code="null";
                new_beneficiary_name="null";
                new_paymode_gl="null";
                new_paymode_credit_ddtranbranch="";
                new_paymode_credit_ddpaybranch="";
            }


            header_values = {
                        "Paymentheader_Date": $filter('date')(new Date(), "yyyy-MM-dd"),
                        "Paymentheader_Amount": parseFloat(total_amounts).toFixed(2),
                        "REF_Gid":  $scope.ref_id,
                        "Payment_Mode":new_paymode,
                        "Bank_Detail_Gid": new_bank_details_gid,
                        "Paymentheader_Status": "PAYMENT INITIATE",
                        "Remark": "PAYMENT INITIATE",
                        "Header_type": $scope.header_type,
                        "bankbranch_name":new_branch_name ,
                        "bankdetails_acno":new_account_number,
                        "ifsccode":new_ifsc_code ,
                        "beneficiaryname":new_beneficiary_name,
                        "paymode_glno":new_paymode_gl,
                        "credit_ddtranbranch":new_paymode_credit_ddtranbranch,
                        "credit_ddpaybranch":new_paymode_credit_ddpaybranch
            }
            header_json.push(header_values);
            detail_json = {"DETAILS":detail_json}
            header_json={"HEADER":header_json}

            var r = confirm("Are You Sure To prepare Payment");
                if (r == true) {
                    $scope.loading_popup();
                    var setpayment = servicesummary.setpayment(header_json, detail_json);
                    setpayment.then(function(result) {
                        if (result.data == "SUCCESS") {
                            alert("Payment Prepared");
                            $window.location.href = "PreparePayment";
                        }
                        else{
                            alert(JSON.stringify(result.data));
                            $scope.endloading();
                            $window.location.href = "PreparePayment";
                        }
                    }, function(err) {
                        alert(res);
                    }).finally($scope.endloading);
                } else
                {
                }
         }


        $scope.bilentry_data=function(detail){
            var checkerdtl = {
                type: detail.invoiceheader_invoicetype,
                invoiceheader_gid: detail.invoiceheader_gid,
                supplier_gid: detail.supplier_gid,
                type_of_page:"PREPARE_PAYMENT"
            };
            sessionStorage.setItem('checkerdtl', JSON.stringify(checkerdtl));
            $window.location.href = "billentry_checker";
        }

        $scope.get_branch = function(query) {
            var datas={params:{"type":"Mode","Sub_Type":"Summary_new",
                               "FILTER":{"Limit_Start":0,"Limit_End":30,"branch_name":"","branch_detail":query,
                                            "branch_code":""},"CLASSIFICATION":{"Entity_Gid":[0]}}};
            return $http.post(Appname + '/classificationdata_get/' , datas).then(function(data) {
                var final_values=data.data.DATA;
                console.log(final_values);
                 return final_values;
                });
        }
        $scope.clear_seach=function(){
            $scope.selectedtype=[];
            $scope.supplier_name="";
            $scope.invoicenum="";
            $scope.invoiceamt="";
            $scope.from_date="";
            $scope.to_date="";
            $scope.invoiceheader_crno="";
            $scope.selected_branch="";
            $scope.branch_gid="";
            $scope.selectedemp="";
            $scope.employee_gid="";
        }

        var channel = servicesummary.get_invoice_types('invoiceheader', 'invoicetype');
            channel.then(function(result) {
                    var Invoice = JSON.parse(result.data)
                    $scope.Invoice_Types =Invoice;
                    console.log($scope.Invoice_Types);
                },
                function(err) {
                    alert('No data!.');
                }).finally();


    }
]);

app.service("servicesummary", function ($http) {

   this.ddl=function(tablename,columnname){
        var response=$http.get(Appname+"/get_custdata/",{params:{"tablename":tablename,"columnname":columnname}});
        return response;
    }

   this.getdropdown = function (tablename) {
        var responsee = $http.post(Appname+"/Dropdown_detail_ap/",{params:{"tablename":tablename,"gid":0,"name":''}});
        return responsee;
    }


      this.setinwardservice = function (action,type,header,details) {
        var responsee = $http.post(Appname+"/setinwardentry/",{params:{"Action":action,"Type":type,"lj_header":header,"lj_details":details}});
        return responsee;
    }

    this.getmakerservice = function () {
        var response=$http.post(Appname+"/ECFInvoice_get/",{params:{"action":"INVOICE_MAKER_SUMMARY","ecfnumber":"","supplier_gid":0,"inwarddetail_gid":0,"inwardheader_gid":0,"status":"maker"}});
        return response;
    }

    this.get_ecf_maker_summary = function (datas) {
        var response=$http.post(Appname+"/get_onward_data/",datas);
        return response;
    }

    this.approvalset=function(status_json){
        var response=$http.post(Appname+"/ECF_Multiple_Approve/",{params:{"action":"UPDATE","type":"STATUS","sub_type":"MULTIPLE_UPDATE","header_json":{},"debit_json":{},"detail_json":{},"status_json":status_json}});
        return response;
    }
    this.setpayment = function (header,details) {
          var response = $http.post(Appname+"/APpayment_set/",{params:{"action":"Insert","type":"PAYMENT_ADD","header_json":header,"detail_json":details,"other_json":{},"status_json":{}}})
          return response;
    }

    this.get_invoice_types=function(tablename,columnname){
            var response=$http.get(Appname+"/get_custdata/",{params:{"tablename":tablename,"columnname":columnname}});
            return response;
   }

   this.get_lock_data_service=function (data) {
        var response=$http.post(Appname+"/common_lock_data/",data);
        return response;
   }


});






































</script>
{% endblock %}