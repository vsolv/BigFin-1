{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %}Customer Mapping  {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}
<div class="maincontent">
    <div class="container container1" ng-app="appprodmap" ng-controller="ctrlprodmap" ng-cloak>
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>Customer Mapping Rate Card Summary</h4>
            </div>
        </div>
        <div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" data-backdrop="static"
     data-keyboard="false"
     id="mdl_present1"
     role="dialog" tabindex="-1">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header popup-header">
                <h5 class="modal-title" id="exampleModalLabel1">
                    Rate Card Details
                </h5>
            </div>
            <div class="modal-body popup-body">
                <div class="row">
                    <!--Leave details-->
                    <form name="myForm">
                        <div class="col-xs-12">
                            <div class="col-md-6">
                                <md-autocomplete
                                        md-clear-button="!disblpop"
                                        md-item-text="item.state_name"
                                        md-items="item in statesearch(searchText)"
                                        md-min-length=0
                                        md-no-cache="true"
                                        md-search-text="searchText"
                                        md-selected-item="add.statnme"
                                        md-selected-item-change="clkstat(item)"
                                        ng-disabled="disblpop"
                                        md-floating-label="State Name"
                                        md-clear-button="true"
                                >
                                    <md-item-template>
                                        <span md-highlight-text="searchText"> {{item.state_name}} </span>
                                    </md-item-template>
                                    <md-not-found>
                                        No State Name matching "{{searchText}}" were found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div class="col-md-6">
                                <md-autocomplete
                                        md-clear-button="!disblpop"
                                        md-item-text="item.campaign_name"
                                        md-items="item in querySearch(search)"
                                        md-min-length=0
                                        md-no-cache="true"
                                        md-search-text="search"
                                        md-selected-item="add.camname"
                                        md-selected-item-change="clkcam(item.campaign_gid)"
                                        ng-disabled="disblpop"
                                        md-floating-label="Campaign"
                                        md-clear-button="true"
                                >
                                    <md-item-template>
                                        <span md-highlight-text="search"> {{item.campaign_name}} </span>
                                    </md-item-template>
                                    <md-not-found>
                                        No Campaign matching "{{search}}" were found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                        </div>

                        <div class="col-xs-12">
                            </br>
                            <div class="col-md-6">
                                <md-autocomplete
                                        md-clear-button="!disblpop"
                                        md-item-text="item.customergroup_name"
                                        md-items="item in getcustmer(searchcus)"
                                        md-min-length=0
                                        md-no-cache="true"
                                        md-search-text="searchcus"
                                        md-selected-item="add.custgrp"
                                        md-selected-item-change="clkcam(item)"
                                        ng-disabled="disblpop"
                                        md-floating-label="Customer Group Name"
                                        md-clear-button="true"
                                >
                                    <md-item-template>
                                        <span md-highlight-text="searchcus"> {{item.customergroup_name}} </span>
                                    </md-item-template>
                                    <md-not-found>
                                        No Customer Name matching "{{searchcus}}" were found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div class="col-md-6">
                                <md-autocomplete
                                        md-clear-button="!disblpop"
                                        md-item-text="item.product_name"
                                        md-items="item in product_Search(searchTex)"
                                        md-min-length=0
                                        md-no-cache="true"
                                        md-search-text="searchTex"
                                        md-selected-item="add.prodname"
                                        md-selected-item-change="prodclck(item)"
                                        ng-disabled="disblpop"
                                        md-floating-label="Product Name"
                                        md-clear-button="true"
                                >
                                    <md-item-template>
                                        <span md-highlight-text="searchTex"> {{item.product_displayname}} </span>
                                    </md-item-template>
                                    <md-not-found>
                                        No Product Name matching "{{searchTex}}" were found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>DIR price</label>
                                    <input maxlength="8"  name="number" ng-disabled="disblpop"
                                           ng-model="add.dirprice1"
                                           numbers-only required/>
                                </md-input-container>
                            </div>
                            <div class=" col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Atdl%</label>
                                    <input maxlength="8" name="pckt" name="number" ng-change="chngatl(add)"
                                           ng-disabled="disblpop"
                                           ng-model="add.atdl"
                                           required valid-number/>
                                </md-input-container>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Min Quality%</label>
                                    <input maxlength="8" name="pckt" name="number" ng-disabled="disblpop"
                                           ng-model="add.minqn"
                                           numbers-only required/>
                                </md-input-container>
                            </div>
                            <div class="col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Max Quality%</label>
                                    <input maxlength="8" name="pckt" name="number" ng-disabled="disblpop"
                                           ng-model="add.maxqn"
                                           numbers-only required/>
                                </md-input-container>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Valid From Date</label>
                                    <md-datepicker md-hide-icons="calendar" md-min-date="maxDate" md-open-on-focus
                                         ng-disabled="disblpop"  ng-model="add.valdfrmdte"></md-datepicker>
                                </md-input-container>
                            </div>
                            <div class="col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Valid To Date</label>
                                    <md-datepicker md-hide-icons="calendar"
                                                   md-min-date="add.valdfrmdte"
                                                   md-open-on-focus
                                                    ng-model="add.valdtodate" formatDate></md-datepicker>
                                </md-input-container>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Final Amount</label>
                                    <input maxlength="16" name="numbr"
                                           ng-model="add.AWS_no"
                                           ng-change="final_amount(add)"
                                           valid-number
                                           ng-disabled="disblpop"
                                           required />
                                </md-input-container>
                            </div>

                            <div class=" col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Active</label>
                                    <md-select name="cname" ng-disabled="disblpop"
                                               ng-init="add.actve = review_status[0].value"
                                               ng-model="add.actve" required>
                                        <md-option><em>--Select--</em></md-option>
                                        <md-option ng-repeat="s in review_status"
                                                   ng-value="s.value"
                                        >
                                            {{ s.status }}
                                        </md-option>
                                    </md-select>
                                </md-input-container>
                            </div>
                        </div>
                        <div class="col-md-12" ng-hide="reject">
                            <div class="col-md-6">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Reject Reason</label>
                                    <input maxlength="64" name="pckt" name="text" ng-hide="reject"
                                           ng-model="add.packets" required/>
                                </md-input-container>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div align="center" class="modal-footer">
                <div align="center" class="row">
                    <div class="col-md-12">
                        <md-button class="md-raised custbutton md-warn" ng-click="popedit(add)" ng-show="showfr1">
                            Submit
                        </md-button>
                        <md-button class="md-raised custbutton md-warn" ng-click="aprv(add)" ng-show="showfr">Approve
                        </md-button>
                        <md-button class="md-raised custbutton md-warn" ng-click="hide_data()" ng-show="showfr">Reject
                        </md-button>
                        <md-button class="md-raised custbutton md-warn" ng-click="rejctpop(add)" ng-show="rejctclk">
                            Reject
                        </md-button>
                        <md-button class="md-raised" data-dismiss="modal" ng-click="clspop()">Close
                        </md-button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        <div class="row" class="col-md-12">
            <br>
            <div class="col-md-3">
                <md-autocomplete
                        md-item-text="item.campaign_name"
                        md-items="item in querySearch(searchTex)"
                        md-min-length=0
                        md-no-cache="true"
                        md-search-text="searchTex1"
                        md-selected-item="selectedItem"
                        md-selected-item-change="ACselectchange(item.campaign_name)"
                        md-floating-label="Campaign"
                        md-clear-button="true"
                >
                    <md-item-template>
                        <span md-highlight-text="searchTex1"> {{item.campaign_name}} </span>
                    </md-item-template>
                    <md-not-found>
                        No product matching "{{searchTex1}}" were found.
                    </md-not-found>
                </md-autocomplete>
            </div>
            <div class="col-md-4">
                <md-autocomplete
                        md-item-text="item.customergroup_name"
                        md-items="item in getcustmer(searchTet)"
                        md-min-length=0
                        md-no-cache="true"
                        md-search-text="searchTet"
                        md-selected-item="selectedIte"
                        md-selected-item-change="ACselectchange(item.customergroup_gid)"
                        ng-disabled="Customer_disable"
                        md-floating-label="Customer Group Name"
                        md-clear-button="true"

                >
                    <md-item-template>
                        <span md-highlight-text="searchTet"> {{item.customergroup_name}} </span>
                    </md-item-template>
                    <md-not-found>
                        No product matching "{{searchTet}}" were found.
                    </md-not-found>
                </md-autocomplete>
            </div>
            <div class="col-md-4">
                <md-autocomplete
                        md-item-text="item.product_name"
                        md-items="item in getproduct(searchText)"
                        md-min-length=0
                        md-no-cache="true"
                        md-search-text="searchText"
                        md-selected-item="selectedone"
                        md-selected-item-change="ACselectchange(item)"
                        ng-disabled="Customer_disable"
                        md-floating-label="Product"
                        md-clear-button="true"

                >
                    <md-item-template>
                        <span md-highlight-text="searchText"> {{item.product_name}} </span>
                    </md-item-template>
                    <md-not-found>
                        No product matching "{{searchText}}" were found.
                    </md-not-found>
                </md-autocomplete>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-2">
                        <md-input-container class="md-block">
                            <label>From Date</label>
                            <md-datepicker md-hide-icons="calendar" md-max-date="maxDate" ng-model="searchquery_StartDate"></md-datepicker>
                        </md-input-container>
                    </div>
                    <div class="col-md-2">
                        <md-input-container class="md-block ">
                            <label>To Date</label>
                            <md-datepicker md-hide-icons="calendar" md-min-date="searchquery_StartDate" ng-model="searchquery_EndDate"></md-datepicker>
                        </md-input-container>
                    </div>
                    <div class="col-md-4" style="margin-top:12px">
                        <md-button class="md-fab md-mini md-primary custbutton" ng-click="serch()">
                            <md-icon>search</md-icon>
                            <md-tooltip>Search</md-tooltip>
                        </md-button>
                    </div>
                    <div class="col-md-3" style="margin-top:12px;margin-left:95px">
                <md-button class="md-fab md-mini md-primary custbutton" ng-click="showpop()">
                    <md-icon>add</md-icon>
                    <md-tooltip>Create New</md-tooltip>
                </md-button>
            </div>
                </div>
            </div>
        </div>
        <div class="row table-responsive">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                    <thead class="header">
                    <tr>
                        <th>S.No</th>
                        <th>State Name</th>
                        <th>Campaign</th>
                        <th>Customer Group Name</th>
                        <th>Product</th>
                        <th>Valid From</th>
                        <th>Valid To</th>
                        <th>min qty</th>
                        <th>max qty</th>
                        <th>adtl%</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Select</th>
                        <th>Action</th>

                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="emp in empsmry.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage))  | filter:search:strict ">
                        <td>
                            <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                        </td>
                        <td>{{emp.state_name}}</td>
                        <td>{{emp.campaign_name }}</td>
                        <td>{{emp.customergroup_name}}</td>
                        <td>{{emp.product_name}}</td>
                        <td>{{emp.ratecard_validfrom}}</td>
                        <td>{{emp.ratecard_validto}}</td>
                        <td>{{emp.ratecard_minqty}}</td>
                        <td>{{emp.ratecard_maxqty}}</td>
                        <td>{{emp.ratecard_discount}}</td>
                        <td class="text-right">{{emp.ratecard_finalrate | number:2}}</td>
                        <td>{{emp.ratecard_status}}</td>
                        <td class="text-center"><input ng-click="selectEntity(emp)"
                                                       ng-model="emp.isChecked"
                                                       type="checkbox">
                        </td>
                        <td>
                          <span title="Edit"  ng-click="edit_data(emp)" align="center"
                                  class="editlink">
                                    <i class="material-icons">edit</i>
                            </span>
                         </td>

                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="12">
                            <ul boundary-links="true" class="pagination-sm cust_pagination"
                                items-per-page="itemsPerPage"
                                max-size="maxSize"
                                ng-model="currentPage" total-items="pageLength"
                                uib-pagination></ul>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div align="center" class="row">
            <div class="col-md-12">
                <div class="col-md-12">
                    <md-button class="btn btn-info custbutton" ng-disabled="update_dealer" ng-click="updealrprc()">Update Dealer Price
                    </md-button>
                    <md-button class="btn btn-info custbutton" ng-click="buksubmit()" ng-disabled="bulksbmtshw">Bulk
                        Submit
                    </md-button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 col-sm-12" ng-include="'custpopup'"></div>
        </div>
    </div>
</div>
{% endverbatim %}
<script>
    var myApp = angular.module('appprodmap', ['ngMaterial', 'ui.bootstrap', 'AppCommon', 'ngMessages'])
        .config(function($httpProvider) {
            $httpProvider.defaults.xsrfCookieName = 'csrftoken';
            $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
        });

myApp.run(function($mdDateLocale, $filter) {
    $mdDateLocale.formatDate = function(date) {
        return $filter('date')(date, "dd-MMM-yyyy");
    };
})

myApp.controller('ctrlprodmap', ['$scope', 'testService', '$mdDialog', '$rootScope', '$window', '$filter',
    function($scope, testService, $mdDialog, $rootScope, $window, $filter) {

        var detail = JSON.parse(sessionStorage.getItem('today'));
        $scope.emp_gid = detail.employee_gid;
        $scope.date = new Date();

        $scope.entity_gid = detail.entity_gid;
        $scope.maxDate = new Date();
        $scope.empsmry = [];
        $scope.showfr = false;
        $scope.disblpop = false;
        $scope.showfr1 = true;
        $scope.bulksbmtshw = true;
        $scope.update_dealer=true;
        $scope.reject = true;
        $scope.currentPage = 1;
        $scope.check=true;
        removeval = [];
        $scope.add = [];
        $scope.getcompaign = [];
        $scope.maxSize = 3;
        $scope.empsmry1=[];
        $scope.itemsPerPage = 10;
        $scope.loading = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.body),
                clickOutsideToClose: false
            });
        };

        $scope.endloading = function() {
            $mdDialog.hide();
        };


        $scope.edit_data = function(emp) {
        modalshow('mdl_present1');

           $scope.add.statnme=emp.state_name;
           $scope.add.camname=emp.campaign_name;
           $scope.add.campaign_gid=emp.ratecard_campaigngid;
           $scope.add.custgrp=emp.customergroup_name;
           $scope.add.customergroup_gid=emp.customergroup_gid;
           $scope.add.prodname=emp.product_name;
           $scope.add.product_gid=emp.product_gid;
           $scope.add.dealerprice_gid=emp.ratecard_dealerpricegid;
           $scope.add.dirprice1=emp.ratecard_dealerprice;
           $scope.add.atdl=emp.ratecard_discount;
           $scope.add.minqn=emp.ratecard_minqty;
           $scope.add.maxqn=emp.ratecard_maxqty;
           $scope.add.valdfrmdte= $filter('date')($scope.date, "yyyy-MM-dd");
           $scope.add.valdtodate=emp.ratecard_validto;
           $scope.add.AWS_no=emp.ratecard_finalrate;
           $scope.add.actve=emp.ratecard_isactive;
           $scope.disblpop = true;
        };

        $scope.querySearch = gotoGetdata;
        $scope.getcustmer = gotocustmr;
        $scope.getproduct = gotoprod;
        $scope.statesearch = gotostate;
        $scope.product_Search = gotoproduct;


        function gotostate(query) {
            var result = $filter('filter')($scope.statesmry, {
                'state_name': query
            });
            return result;
        }

        function gotoproduct(query) {
            var result = $filter('filter')($scope.prodnme, {
                'product_displayname': query
            });
            return result;
        }

        function gotoGetdata(query) {
            var result = $filter('filter')($scope.getcompaign, {
                'campaign_name': query
            });
            return result;
        }

        function gotocustmr(query) {
            var result = $filter('filter')($scope.mullti, {
                'customergroup_name': query
            });
            return result;
        }

        function gotoprod(query) {
            var result = $filter('filter')($scope.prodnme, {
                'product_name': query
            });
            return result;
        }

        $scope.selectEntity = function(data) {
        //alert("hai");
            for (var i = 0; i < $scope.empsmry.length; i++) {
                if ($scope.empsmry[i].isChecked) {
                    $scope.bulksbmtshw = $scope.check;
                    $scope.empsmry.allItemsSelected = false;
                    return;
                } else {
                    $scope.bulksbmtshw = true;
                    $scope.empsmry.allItemsSelected = false;
                }
            }
            $scope.empsmry.allItemsSelected = false;
        };

        $rootScope.showpop = function() {
            modalshow('mdl_present');
        }

        $scope.adtnlchn = function(add) {
            if($scope.add.atdl<=100 && ($scope.add.atdl>=0))
            {
            $scope.add.AWS_no = ((parseFloat($scope.add.dirprice) * parseFloat($scope.add.atdl)) / 100) + $scope.add.dirprice;
            $scope.add.AWS_no=$scope.add.AWS_no.toFixed(2)
            }
            else if($scope.add.atdl>100)
            {
            alert("additional % is exceeding the maximum percentage");
            $scope.add.AWS_no='';
            }
            else if($scope.add.atdl <-100)
            {
            $scope.add.AWS_no='';
            alert("value should be entered atleast less than -100%");
            }
            else
            {
            $scope.add.AWS_no='';
            }

        }

         $scope.chngatl = function(add) {

        if(parseFloat($scope.add.atdl)<-100.00)
        {
        alert("additional % is exceeding the maximum percentage");
        $scope.add.AWS_no='';
        }
        else if(parseFloat($scope.add.atdl)<=100.00)
        {
              $scope.add.AWS_no = ((parseFloat($scope.add.dirprice) * parseFloat(add.atdl)) / 100) + $scope.add.dirprice;
            $scope.add.AWS_no=$scope.add.AWS_no.toFixed(2);
        }
        else if(parseFloat($scope.add.atdl)>100.00)
        {
        $scope.add.AWS_no='';
        alert("additional % is exceeding the maximum percentage")
        }
        else
        {
        $scope.add.AWS_no='';
        }

        }

        $scope.final_amount=function(add)
        {

             if(parseFloat($scope.add.AWS_no)>parseFloat($scope.add.dirprice))
                 {
                 $scope.greater=(parseFloat($scope.add.AWS_no)-parseFloat($scope.add.dirprice))*100/
                 $scope.add.dirprice;
                    if(parseFloat($scope.greater)>100.00)
                    {
                    alert("Customer Price Amount is exceeding 100% in additional percentage");
                    $scope.add.atdl='';
                    }
                    else
                    {
                    $scope.add.atdl=$scope.greater.toFixed(2);
                    }
                 }
             else if(parseFloat($scope.add.AWS_no)<parseFloat($scope.add.dirprice))
                {
                     $scope.lesser=(parseFloat($scope.add.dirprice)-parseFloat($scope.add.AWS_no))*100/
                     $scope.add.dirprice;
                     if(parseFloat($scope.lesser)>100.00)
                     {
                      alert("Customer Price Amount is exceeding -100% in additional percentage");
                        $scope.add.atdl='';
                     }
                     else
                     {
                     $scope.add.atdl=-$scope.lesser.toFixed(2);
                     }
                }
             else if(parseFloat($scope.add.AWS_no)==parseFloat($scope.add.dirprice))
             {
                $scope.add.atdl=parseFloat($scope.add.AWS_no)-parseFloat($scope.add.dirprice);
             }
             else if($scope.add.AWS_no == undefined)
             {
             $scope.add.atdl='';
             }

        }

        $scope.updealrprc = function() {

            $scope.check=false;
            $scope.update_dealer = true;
            $scope.loading();
            $scope.bulky = [];
            $scope.data = [];
            var z=0;
            $scope.value=[];
            $scope.value1=[];
            var bulk = '';
            var data = '';
            var size=$scope.empsmry.length;
            $scope.total=[];


                for(var i=0;i<$scope.empsmry.length;i++)
                {
                bulk = $scope.empsmry[i].product_gid;
                data = $scope.empsmry[i].dealerprice_statepricegid;
                $scope.data.push(data);
                $scope.bulky.push(bulk);
                }

            var datas = {
                "Params": {
                    "Filter": {
                        "ProductId": $scope.bulky,
                        "StatePriceGid": $scope.data,
                        "Status": 'APPROVED'
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": [$scope.entity_gid]
                    }
                }
            }

            var data = {
                Group: 'BULK_SUMMARY',
                Sub_Type: 'DEALER_PRICE',
                Type: 'BULK_UPDATE',
                Employee_Gid: $scope.emp_gid,
                data: datas
            }
            setdealprc(data);
            $scope.endloading();
        }

        function setdealprc(data) {
            var get_prodmap = testService.prodmapsmry(data)
            get_prodmap.then(function(result) {

                    $scope.maintab = result.data.DATA;
                    for (var i = 0; i < $scope.empsmry.length; i++) {
                        prodgid1 = $scope.empsmry[i].product_gid
                        statgid1 = $scope.empsmry[i].dealerprice_statepricegid
                        rate1 = $scope.empsmry[i].ratecard_dealerprice
                        for (var j = 0; j < $scope.maintab.length; j++) {
                            prodgid2 = $scope.maintab[j].dealerprice_productgid
                            statgid2 = $scope.maintab[j].dealerprice_statepricegid
                            rate2 = $scope.maintab[j].dealerprice_rate
                            if ((prodgid1 == prodgid2) && (statgid1 == statgid2) && (rate1 == rate2)) {
                                removeval.push(i);
                            } else if ((prodgid1 == prodgid2) && (statgid1 == statgid2) && (rate1 != rate2)) {
                                $scope.ad = ((($scope.maintab[j].dealerprice_rate) * ($scope.maintab[j].dealerprice_additionalvalue)) / 100) +
                                    $scope.maintab[j].dealerprice_rate
                                $scope.empsmry[i].newval = $scope.maintab[j].dealerprice_rate;
                                $scope.empsmry[i].addtnl = $scope.maintab[j].dealerprice_additionalvalue;
                                $scope.empsmry[i].ratecard_finalrate = $scope.ad;
                            }
                        }
                    }


                    for (var i = removeval.length -1; i >= 0; i--)
                    {
                            $scope.empsmry.splice(removeval[i],1);
                    }
                    $scope.pageLength = $scope.empsmry.length;
                    $scope.Totalpages = Math.ceil($scope.empsmry.length / $scope.itemsPerPage);
                    $scope.pageLength = $scope.empsmry.length;

                }, function(err) {
                    alert('No data!.');
                })
                .finally();
        };

        var data = {
            "Parms": {
                "Classification": {
                    "Entity_Gid": [$scope.entity_gid]
                },
                "Filter": {
                    "XXXXX": ""
                }
            }
        }


        var dta = {
            Group: 'CAMPAIGN_GET',
            Type: 'INVOICE',
            SubType: 'SALES',
            data: data

        }

        var getcompaig = testService.getdrpdwn(dta)
        getcompaig.then(function(result) {
            $scope.getcompaign = result.data.DATA;
        }, function(err) {
            alert('No data!.');
        }).finally();

        var data = {
            Group: 'CUST_GROUP_GET',
            Entity_Gid: $scope.entity_gid,
            Cust_Group_Gid: 0,
            Cust_Group_Code: 0,
            Cust_Group_Name: '',
            Query_Limit: ' 1,2000'
        }

        var custgrpddl = testService.getcustgrp(data)
        custgrpddl.then(function(result) {
                $scope.mullti = [];
                $scope.mullti = result.data.DATA;
                if ($scope.selectedcustgrp != undefined) {
                    textvalue($scope.selectedcustgrp)
                }
            }),
            function() {
                alert('no data');
            };

        var get_employ = testService.getprod('100', '')
        get_employ.then(function(result) {
                $scope.prodnme = [];
                $scope.prodnme = result.data.DATA;
                if ($scope.selectedcustgrp != undefined) {
                    textvalue($scope.selectedcustgrp)
                }
            }),
            function() {
                alert('no data');
            };

        $scope.loading();
        loaddata();
        loadstate();
        $scope.endloading()

        function loadstate() {
            var data = {
                "Parms": {
                    "Classification": {
                        entity_gid: [$scope.entity_gid]
                    },
                    "Filter": {
                        State_gid: ""
                    }
                }
            }

            var data_in = {
                Subtype: 'MAKER',
                Type: 'DDL',
                Emp_Gid: $scope.emp_gid,
                data: data
            };
            getstatenme(data_in);
        }

        function getstatenme(data_in) {
            var get_state = testService.getstate(data_in)
            get_state.then(function(result) {
                    $scope.statesmry = result.data.DATA;
                }, function(err) {
                    alert('No data!.');
                })
                .finally();
        };

        function loaddata() {
            var data = {
                "Params": {
                    "FILTER": {
                        Campaign_Id: '',
                        Customer_Group_Gid: '',
                        Product_Gid: '',
                        Valid_From: '',
                        Valid_To: '',
                        Status: 'APPROVED'
                    },
                    "CLASSIFICATION": {
                        Entity_Gid: [$scope.entity_gid]
                    }
                }
            }

            var data_int = {
                Sub_Type: 'SUMMARY_APPROVED',
                Type: 'SUMMARY',
                Group: 'SUMMARY',
                Employee_Gid: $scope.emp_gid,
                Limit: 1500,
                data: data
            };
            prodmapsmry(data_int);
        }

        function prodmapsmry(data_int) {
            var get_prodmap = testService.prodmapsmry(data_int)
            get_prodmap.then(function(result) {
                    $scope.maintable = result.data.DATA;
                    $scope.empsmry = $scope.maintable
                    if($scope.empsmry.length>0)
                    {
                    $scope.update_dealer=false;
                    }
                    $scope.pageLength = $scope.empsmry.length;
                    $scope.Totalpages = Math.ceil($scope.empsmry.length / $scope.itemsPerPage);
                    $scope.pageLength = $scope.empsmry.length;
                }, function(err) {
                    alert('No data!.');
                })
                .finally();
        };

        $scope.clspop = function() {
            $scope.loading();
            $window.location.href = "custpdctratecardmaker";
            $scope.endloading();

        }

        $scope.serch = function() {
            $scope.loading();
            if ($scope.selectedItem !== null) {
                $scope.campid = $scope.selectedItem.campaign_gid;
            } else {
                $scope.campid = 0;
            }
            if ($scope.selectedIte !== null) {
                $scope.custgid = $scope.selectedIte.customergroup_gid;
            } else {
                $scope.custgid = 0;
            }
            if ($scope.selectedone !== null) {
                $scope.prod_id = $scope.selectedone.product_gid;
            } else {
                $scope.prod_id = 0;
            }

            if ($scope.searchquery_StartDate == undefined && $scope.searchquery_EndDate == undefined) {
                var data = {
                    "Params": {
                        "FILTER": {
                            Campaign_Id: $scope.campid,
                            Customer_Group_Gid: $scope.custgid,
                            Product_Gid: $scope.prod_id,
                            Valid_From: '',
                            Valid_To: '',
                            Status: 'APPROVED'
                        },
                        "CLASSIFICATION": {
                            Entity_Gid: [$scope.entity_gid]
                        }
                    }
                }
            } else if ($scope.searchquery_StartDate != undefined && $scope.searchquery_EndDate == undefined) {
                $scope.searchquery_EndDate = new Date();
                var data = {
                    "Params": {
                        "FILTER": {
                            Campaign_Id: $scope.campid,
                            Customer_Group_Gid: $scope.custgid,
                            Product_Gid: $scope.prod_id,
                            Valid_From: formatStringDate($scope.searchquery_StartDate, 'yyyy-mm-dd'),
                            Valid_To: formatStringDate($scope.searchquery_EndDate, 'yyyy-mm-dd'),
                            Status: 'APPROVED'
                        },
                        "CLASSIFICATION": {
                            Entity_Gid: [$scope.entity_gid]
                        }
                    }
                }
            } else if ($scope.searchquery_EndDate != undefined && $scope.searchquery_StartDate != undefined) {
                var data = {
                    "Params": {
                        "FILTER": {
                            Campaign_Id: $scope.campid,
                            Customer_Group_Gid: $scope.custgid,
                            Product_Gid: $scope.prod_id,
                            Valid_From: formatStringDate($scope.searchquery_StartDate, 'yyyy-mm-dd'),
                            Valid_To: formatStringDate($scope.searchquery_EndDate, 'yyyy-mm-dd'),
                            Status: 'APPROVED'
                        },
                        "CLASSIFICATION": {
                            Entity_Gid: [$scope.entity_gid]
                        }
                    }
                }
            } else if ($scope.searchquery_EndDate != undefined && $scope.searchquery_StartDate == undefined) {
                $scope.searchquery_StartDate = $scope.searchquery_EndDate;
                var data = {
                    "Params": {
                        "FILTER": {
                            Campaign_Id: $scope.campid,
                            Customer_Group_Gid: $scope.custgid,
                            Product_Gid: $scope.prod_id,
                            Valid_From: formatStringDate($scope.searchquery_StartDate, 'yyyy-mm-dd'),
                            Valid_To: formatStringDate($scope.searchquery_EndDate, 'yyyy-mm-dd'),
                            Status: 'APPROVED'
                        },
                        "CLASSIFICATION": {
                            Entity_Gid: [$scope.entity_gid]
                        }
                    }
                }
            }

            var data_int = {
                Sub_Type: 'SUMMARY_APPROVED',
                Type: 'SUMMARY',
                Group: 'SUMMARY',
                Employee_Gid: $scope.emp_gid,
                Limit: 1500,
                data: data
            };
            prodmapsmry(data_int);
            $scope.endloading();
        }




        $scope.prodclck = function(co) {

            var dta = {
                "Params": {
                    "FILTER": {
                        "State_Gid": $scope.add.statnme.state_gid,
                        "Product_Gid": co.product_gid
                    },
                    "CLASSIFICATION": {
                        "entity_gid": [$scope.entity_gid]
                    }
                }
            }

            var data = {
                "Group": 'DEALER_PRICE_UNIQUE',
                "Type": 'DEALER_PRICE',
                "Sub_Type": 'RATE_CARD',
                "Employee_Gid": $scope.emp_gid,
                "data": dta
            }
            getdirvalue(data)
        }

        function getdirvalue(data) {
            var get_prodmap = testService.getdirval(data)
            get_prodmap.then(function(result) {
                    $scope.maint = result.data.DATA;
                    $scope.add.dirprice = $scope.maint[0].dealerprice_amount;
                    $scope.dealerprice_gid = $scope.maint[0].dealerprice_gid;
                }, function(err) {
                    alert('No data!.');
                })
                .finally();
        };

        $scope.buksubmit = function() {

            $scope.loading();
            $scope.bulky = [];
            var data = [];
            for (i = 0; i < $scope.empsmry.length; i++) {
                if ($scope.empsmry[i].isChecked) {
                    $scope.empsmry[i].ratecard_validfro = convertdate($scope.empsmry[i].ratecard_validfrom);
                    $scope.empsmry[i].ratecard_validt = convertdate($scope.empsmry[i].ratecard_validto);
                    if($scope.empsmry[i].customergroup_gid == null)
                    {
                   $scope.empsmry[i].customergroup_gid='';
                    }
                    data = {
                        "CampaignGid": $scope.empsmry[i].ratecard_campaigngid,
                        "Customer_GroupGid": $scope.empsmry[i].customergroup_gid,
                        "ProductGid": $scope.empsmry[i].product_gid,
                        "DealerPriceGid": $scope.empsmry[i].ratecard_dealerpricegid,
                        "Remarks": 'gh',
                        "MinQty": $scope.empsmry[i].ratecard_minqty,
                        "MaxQty": $scope.empsmry[i].ratecard_maxqty,
                        "DealerPrice": $scope.empsmry[i].newval,
                        "Discount": $scope.empsmry[i].addtnl,
                        "FinalRate": $scope.empsmry[i].ratecard_finalrate.toFixed(2),
                        "ValidFrom": formatStringDate($scope.empsmry[i].ratecard_validfro, 'yyyy-mm-dd'),
                        "ValidTo": formatStringDate($scope.empsmry[i].ratecard_validt, 'yyyy-mm-dd'),
                        "Status": "PENDING",
                        "Is_Active": $scope.empsmry[i].ratecard_isactive
                    }
                    $scope.bulky.push(data);
                }
            }

            var dta = {
                "Params": {
                    "DATA": {
                        "Sales_Rate": $scope.bulky
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": [$scope.entity_gid]
                    }
                }
            }
            var data_int = {
                Group: 'MAKER',
                Action: 'Insert',
                Type: 'INITIAL',
                Employee_Gid: $scope.emp_gid,
                data: dta
            }
            prodset(data_int);
            $scope.endloading();
        }

      $scope.submitpop = function(add) {
      $scope.loading();

      var campaign=$scope.add.camname.campaign_gid;
       if(campaign==1){
       if($scope.add.atdl>0 ||$scope.add.atdl<0){
       alert('Adtl% should not exceed 0 for dealer price');
       return false;
       }
      }

            var minmum = parseInt($scope.add.minqn);
            var maxmum = parseInt($scope.add.maxqn);
            if (minmum >= maxmum) {
                alert('Your Min Quantity Value Should Be Less Than Max Quantity')
                $scope.add.maxqn = '';
                return false;
            }
            if(($scope.add.custgrp)== null  || parseInt($scope.add.custgrp.customergroup_gid)<=0 )
            {
            $scope.add.custgrp='';
            $scope.check=$scope.add.custgrp;
            }
            else
            {
             $scope.check=$scope.add.custgrp.customergroup_gid
            }



         var data = {
                "Params": {
                    "DATA": {
                        "Sales_Rate": [{
                            "CampaignGid": $scope.add.camname.campaign_gid,
                            "Customer_GroupGid": $scope.check,
                            "ProductGid": $scope.add.prodname.product_gid,
                            "DealerPriceGid": $scope.dealerprice_gid,
                            "Remarks": 'gh',
                            "MinQty": $scope.add.minqn,
                            "MaxQty": $scope.add.maxqn,
                            "DealerPrice": parseFloat($scope.add.dirprice).toFixed(2),
                            "Discount": $scope.add.atdl,
                            "FinalRate": parseFloat($scope.add.AWS_no).toFixed(2),
                            "ValidFrom": formatStringDate($scope.add.valdfrmdte, 'yyyy-mm-dd'),
                            "ValidTo": formatStringDate($scope.add.valdtodate, 'yyyy-mm-dd'),
                            "Status": "PENDING",
                            "Is_Active": "Y"
                        }]
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": [$scope.entity_gid]
                    }
                }
            }

            var data_int = {
                Group: 'MAKER',
                Action: 'Insert',
                Type: 'INITIAL',
                Employee_Gid: $scope.emp_gid,
                data: data
            }
            prodset(data_int);
            $scope.endloading();
        }


        $scope.popedit = function(emp) {
        $scope.loading();

       if(($scope.add.customergroup_gid)== null  || parseInt($scope.add.customergroup_gid)<=0 )
            {
                $scope.add.custgrp='';
                $scope.check='';
              }
            else
            {
                $scope.check=$scope.add.customergroup_gid
              }

             var data = {
                "Params": {
                    "DATA": {
                        "Sales_Rate": [{
                            "CampaignGid":  $scope.add.campaign_gid,
                            "Customer_GroupGid": $scope.check,
                            "ProductGid":  $scope.add.product_gid,
                            "DealerPriceGid": $scope.add.dealerprice_gid,
                            "Remarks": 'gh',
                            "MinQty": $scope.add.minqn,
                            "MaxQty": $scope.add.maxqn,
                            "DealerPrice": parseFloat($scope.add.dirprice1).toFixed(2),
                            "Discount": $scope.add.atdl,
                            "FinalRate": parseFloat($scope.add.AWS_no).toFixed(2),
                            "ValidFrom":$filter('date')($scope.add.valdfrmdte, "yyyy-MM-dd"),
                            "ValidTo": $filter('date')($scope.add.valdtodate, "yyyy-MM-dd"),
                            "Status": "PENDING",
                            "Is_Active": "Y"
                        }]
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": [$scope.entity_gid]
                    }
                }
            }

            var data_int = {
                Group: 'MAKER',
                Action: 'Insert',
                Type: 'INITIAL',
                Employee_Gid: $scope.emp_gid,
                data: data
            }
            prodset(data_int);
            $scope.endloading();
        }

        function prodset(data_int) {
            var get_prodmap = testService.prodmapsmry(data_int)
            get_prodmap.then(function(result) {

                    $scope.maintab = result.data.MESSAGE;
                    if ($scope.maintab == 'SUCCESS') {
                        alert($scope.maintab+", Data is moved to Customer Approve Screen");
                        $window.location.href = "custpdctratecardmaker";
                    } else {
                        alert($scope.maintab);
                    }
                }, function(err) {
                    alert('No data!.');
                })
                .finally();
        };

        $scope.review_status = [{
            status: "YES",
            value: 'Y'
        }, {
            status: "NO",
            value: 'N'
        }]
    }
]);

myApp.service("testService", function($http) {
    this.prodmapsmry = function(custid) {
        var respons = $http.post(Appname + "/pmapsmry/",
            custid
        );
        return respons;
    }
    this.getdrpdwn = function(custid) {
        var respons = $http.post(Appname + "/compgn/",
            custid
        );
        return respons;
    }
    this.getcustgrp = function(data) {
        var response = $http.post(Appname + "/custgroup/", data);
        return response;
    }
    this.getprod = function(lmt, prodnme) {
        var response = $http.get(Appname + "/prodgett/", {
            params: {
                "Limit": lmt,
                "Product_Name": prodnme
            }
        });
        return response;
    }
    this.getstate = function(custid) {
        var respons = $http.post(Appname + "/stateget/",
            custid
        );
        return respons;
    }
    this.getdirval = function(custid) {
        var respons = $http.post(Appname + "/prcesmry/",
            custid
        );
        return respons;
    }
});

</script>
{% endblock %}