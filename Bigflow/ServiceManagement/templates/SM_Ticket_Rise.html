{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} Ticket Rise{% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}

<div class="maincontent">
    <div ng-app="App_maker_summary" ng-controller="Ctrl_amc_maker as ctrl" class="container container1">
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>Ticket Rise</h4>
            </div>
        </div>
        </br>
        <div class="row">
            <br/>
            <div class="col-md-12">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel panel-primary">
                                <div class="panel-heading">
                                    <h5>Create New Ticket</h5>
                                </div>
                                <!-- /.panel-heading -->
                                <div class="panel-body">
                                    <form name="createTicket" novalidate>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <dt>
                                                        <label for="id_title">Summary of the problem</label>
                                                    </dt>
                                                    <dd>
                                                        <input type="text" name="title" class="form-control"
                                                               ng-model="ticket_summary" maxlength="100"
                                                               id="id_title" required>
                                                    </dd>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <dt>
                                                        <label for="problem_det">Problem Description</label>
                                                    </dt>
                                                    <dd>
                                                    <textarea id="problem_det" rows="8" cols="151"
                                                              ng-model="ticket_problem" name="comment" required>
                                                    </textarea>
                                                    </dd>
                                                </div>
                                            </div>
                                        </div>
                                        <br/>

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="col-md-3">
                                                    <md-autocomplete
                                                            md-clear-button="true"
                                                            md-floating-label="Choose Branch Name"
                                                            md-input-maxlength=126
                                                            md-item-text="items.branch_name"
                                                            md-items="items in getBranch_Name(searchBranch)"
                                                            md-selected-item-change="BranchChanged(items.branch_gid)"
                                                            md-min-length=0
                                                            md-search-text="searchBranch"
                                                            ng-model="items"
                                                            md-no-cache="true"
                                                            size="5"
                                                            ng-required="true"
                                                            md-selected-item="items.branch_gid">
                                                        <md-item-template>
                                                            <span md-highlight-text="searchTex"> {{items.branch_name}}</span>
                                                        </md-item-template>
                                                        <md-not-found>
                                                            No Supplier Name matching "{{search Vendor}}" were found.
                                                        </md-not-found>
                                                    </md-autocomplete>
                                                </div>
                                                <div class="col-md-3" style="top:10px;">
                                                    <md-input-container class="md-block inputcontainer">
                                                        <md-radio-group layout="row" ng-change="check_radio(type)"
                                                                        ng-model="type">
                                                            <md-radio-button value="AMC">AMC</md-radio-button>
                                                            <md-radio-button value="WARRANTY">WARRANTY</md-radio-button>
                                                            <md-radio-button value="PAID">ALL</md-radio-button>
                                                        </md-radio-group>
                                                    </md-input-container>
                                                </div>
                                                <div class="col-md-4"></div>
                                                <div class="col-md-2" style="top:30px;">
                                                    <md-checkbox ng-model="paid_value"
                                                                 ng-change="change_paid(paid_value)">PAID
                                                    </md-checkbox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="col-md-3">
                                                    <md-input-container class="md-block inputcontainer">
                                                        <label>Asset ID</label>
                                                        <input ng-model="asset_id">
                                                    </md-input-container>
                                                </div>

                                                <div class="col-md-1">
                                                    <md-button class="md-fab md-mini md-primary custbutton"
                                                               ng-click="find_assets(asset_id)">
                                                        <md-icon>search</md-icon>
                                                        <md-tooltip>Search</md-tooltip>
                                                    </md-button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="row table-responsive">
                                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                                        <div class="row table-responsive">
                                                            <div class="col-md-12 col-lg-12 col-sm-12">
                                                                <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                                                       md-progress="deferred">
                                                                    <thead class="header">
                                                                    <tr>
                                                                        <th>S.No</th>
                                                                        <th>Branch Name</th>
                                                                        <th>Vendor Name</th>
                                                                        <th>Asset Name</th>
                                                                        <th>Asset ID</th>
                                                                        <th>Action</th>
                                                                    </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                    <tr align="center"
                                                                        ng-repeat="br_ass in br_assets.slice(((currentPage-1)*itemsPerPage),((currentPage)*itemsPerPage)) | filter:search:strict">
                                                                        <td>
                                                                            <center>
                                                                                {{((currentPage-1)*itemsPerPage)+$index+1}}
                                                                            </center>
                                                                        </td>
                                                                        <td>{{br_ass.branch_name}}</td>
                                                                        <td>{{br_ass.supplier_name}}</td>
                                                                        <td>{{br_ass.product_name}}</td>
                                                                        <td>{{br_ass.assetdetails_id}}</td>
                                                                        <td>
                                                                            <button class="btn btn-sm btn-success"
                                                                                    ng-click="add_assets(br_ass,$index)">
                                                                                <b>+</b>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                    <tr ng-show="br_assets.length == 0">
                                                                        <td class="warning" colspan="12">
                                                                            No Records Found.
                                                                        </td>
                                                                    </tr>
                                                                    </tbody>
                                                                    <tfoot>
                                                                    <tr align="center">
                                                                        <td colspan="4">
                                                                            <ul uib-pagination
                                                                                total-items="br_assets.length"
                                                                                ng-model="currentPage"
                                                                                max-size="maxSize"
                                                                                class="pagination-sm"
                                                                                boundary-links="true"
                                                                                items-per-page="itemsPerPage"></ul>
                                                                        </td>
                                                                        <td colspan="2">
                                                                            Total Count:{{br_assets.length}}
                                                                        </td>
                                                                    </tr>
                                                                    </tfoot>
                                                                </table>
                                                            </div>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <h4 style="color:green;">Vendor Name:{{supplier_name}}</h4>
                                        <div class="row table-responsive">
                                            <div class="col-md-12 col-lg-12 col-sm-12">
                                                <div class="row table-responsive">
                                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                                        <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                                               md-progress="deferred">
                                                            <thead class="header">
                                                            <tr>
                                                                <th>S.No</th>
                                                                <th>Branch Name</th>
                                                                <th>Vendor Name</th>
                                                                <th>Asset Name</th>
                                                                <th>Asset ID</th>
                                                                <th>Action</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            <tr align="center"
                                                                ng-repeat="sel_ass in selected_assets.slice(((currentPages-1)*itemsPerPages),((currentPages)*itemsPerPages)) | filter:search:strict">
                                                                <td>
                                                                    <center>
                                                                        {{((currentPages-1)*itemsPerPages)+$index+1}}
                                                                    </center>
                                                                </td>
                                                                <td>{{sel_ass.branch_name}}</td>
                                                                <td>{{sel_ass.supplier_name}}</td>
                                                                <td>{{sel_ass.product_name}}</td>
                                                                <td>{{sel_ass.assetdetails_id}}</td>
                                                                <td>
                                                                    <a> <i class="material-icons"
                                                                           ng-click="delete_column($index)">
                                                                        delete
                                                                    </i></a>
                                                                </td>
                                                            </tr>
                                                            <tr ng-show="selected_assets.length == 0">
                                                                <td class="warning" colspan="12">
                                                                    No Records Found.
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                            <tfoot>
                                                            <tr align="center">
                                                                <td colspan="4">
                                                                    <ul uib-pagination
                                                                        total-items="selected_assets.length"
                                                                        ng-model="currentPages"
                                                                        max-size="maxSizes"
                                                                        class="pagination-sm"
                                                                        boundary-links="true"
                                                                        items-per-page="itemsPerPages"></ul>
                                                                </td>
                                                                <td colspan="2">
                                                                    Total Count:{{selected_assets.length}}
                                                                </td>
                                                            </tr>
                                                            </tfoot>
                                                        </table>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="col-md-3">
                                                    <md-input-container class="md-block inputcontainer">
                                                        <label>Due Date</label>
                                                        <md-datepicker md-hide-icons="calendar"
                                                                       ng-model="ticket_due_date"
                                                                       md-hide-icons="calendar" ng-click="date"
                                                                       md-min-date="maxDate"
                                                                       md-max-date="minDate"
                                                                       ng-required="true"
                                                                       formatDate></md-datepicker>
                                                    </md-input-container>
                                                </div>
                                                <div class="col-md-1" style="left:30px;">
                                                    <a title="Add Nature of The Problem" align="center"
                                                       data-toggle="modal" ng-required="true"
                                                       data-target="#add_problem"
                                                       style='cursor: pointer; text-decoration:none;color:green;'>
                                                        <i class="material-icons">cloud_upload</i>
                                                    </a>
                                                </div>
                                                <div class="col-md-4">
                                                    <h5>
                                                        <span>Nature Of The Probelm: </span>
                                                        <span ng-if="ErrorCategory_Gid!=0" style="color:green;">{{final_problem}}</span>
                                                        <span ng-if="ErrorCategory_Gid==0"
                                                              style="color:red;">{{final_problem}}</span>
                                                    </h5>
                                                </div>
                                                <div class="col-md-3" ng-hide="paid_status==0">
                                                    <md-autocomplete ng-disabled="paid_status==0"
                                                                     md-clear-button="true"
                                                                     md-floating-label="Choose Vendor"
                                                                     md-input-maxlength=126
                                                                     md-item-text="item.supplier_name"
                                                                     md-items="item in getSupplier_Name(searchSupplier)"
                                                                     md-selected-item-change="SupplierChanged(item.supplier_gid,item.supplier_name)"
                                                                     md-min-length=0
                                                                     md-search-text="searchSupplier"
                                                                     ng-model="item"
                                                                     md-no-cache="true"
                                                                     size="5"
                                                                     md-selected-item="item.supplier_name">
                                                        <md-item-template>
                                                            <span md-highlight-text="searchTex"> {{item.supplier_name}}</span>
                                                        </md-item-template>
                                                        <md-not-found>
                                                            No Supplier Name matching "{{search Vendor}}" were found.
                                                        </md-not-found>
                                                    </md-autocomplete>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2 col-md-offset-5">
                                                <md-button class="md-raised md-warn"
                                                           value="submit"
                                                           ng-click="create_ticket()"
                                                           ng-disabled="createTicket.$invalid">
                                                    Create Ticket
                                                </md-button>
                                            </div>
                                            <div class="col-md-2">
                                                <a href="ServiceManagement/SM_Ticket_Summary/">
                                                    <md-button class="md-raised" value="close"
                                                               aria-label="Close">Cancel
                                                    </md-button>
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal fade" id="add_problem" tabindex="-1" role="dialog"
                                     data-backdrop="static"
                                     data-keyboard="false"
                                     aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header popup-header">
                                                <h5 class="modal-title" id="exampleModalLabel">
                                                    Nature of The Problem</b>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </h5>
                                            </div>
                                            <div class="body">
                                                <div class="modal-body popup-body">
                                                    <div class="row">
                                                        <div class="row" ng-repeat="det in finaldata">
                                                            <div class="col-md-2 col-md-offset-1">
                                                                <md-subheader class="md-primary">
                                                                    {{det.hierarchy_layer}}
                                                                </md-subheader>
                                                                <div style="padding-top:2px;">
                                                                    <md-radio-group ng-model="det.rbtncluster"
                                                                                    class="md-primary">
                                                                        <md-radio-button
                                                                                ng-repeat="cluster in det.clustlist"
                                                                                ng-value="cluster.parent_name"
                                                                                ng-click="rbtnChange(cluster.errorcategory_gid,det.hierarchy_gid,cluster.parent_name)"
                                                                                aria-label="{{ cluster.parent_name }}">
                                                                            {{cluster.parent_name}}
                                                                        </md-radio-button>
                                                                    </md-radio-group>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="col-md-1"></div>
                                                                <div class="col-md-8">
                                                                    <h4>
                                                                        <span>Nature Of The Probelm: </span>
                                                                        <span ng-if="ErrorCategory_Gid!=0"
                                                                              style="color:green;">{{final_problem}}</span>
                                                                        <span ng-if="ErrorCategory_Gid==0"
                                                                              style="color:red;">{{final_problem}}</span>
                                                                    </h4>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="col-md-2 col-md-offset-4">
                                                                    <md-button class="md-raised" value="close"
                                                                               data-dismiss="modal"
                                                                               ng-click="clear_nop()"
                                                                               aria-label="Close">Clear
                                                                    </md-button>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <md-button class="md-raised" value="close"
                                                                               data-dismiss="modal"
                                                                               aria-label="Close">OK
                                                                    </md-button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endverbatim %}


<script>
var myApp = angular.module('App_maker_summary', ['ngMaterial','ui.bootstrap','ngMessages']).config(function($httpProvider,$mdAriaProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
    $mdAriaProvider.disableWarnings();
});
 myApp.run(function($mdDateLocale, $filter) {
    $mdDateLocale.formatDate = function(date) {
        return $filter('date')(date, "yyyy-MMM-dd");
    };
   });
myApp.controller('Ctrl_amc_maker', ['$scope','$mdDateLocale','Service_Ticket','$mdDialog','$window','$filter', function($scope,$mdDateLocale,Service_Ticket,$mdDialog,$window,$filter) {
    $scope.currentPage=1;
    $scope.maxSize=3;
    $scope.itemsPerPage=5;

    $scope.currentPages=1;
    $scope.maxSizes=3;
    $scope.itemsPerPages=5;

    $scope.maxDate = new Date();
    $scope.maintable = [];
    $scope.final_problem="Not Selected";
    $scope.ErrorCategory_Gid=0;
    $scope.branch_gid=0;
    $scope.paid_status=0;
    $scope.supplier_name="";
    $scope.supplier_gid=0;

     $scope.emp_gid=0;
    $scope.ticket_data_summary_all=[];
    if (sessionStorage.getItem('today') != null)
        {
            $scope.emp= JSON.parse(sessionStorage.getItem('today'));
            debugger;
            $scope.emp_gid=$scope.emp.employee_gid;

        }


    $scope.loading = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.body),
                clickOutsideToClose: false
            });
        };

        $scope.endloading = function() {
            $mdDialog.hide();
        };

    var supplier = Service_Ticket.getsupplierdata_sup(0);
        supplier.then(function(result) {
            var supplier = result.data;
            $scope.supplier_list = supplier;
        }, function() {
            alert(supplier)

   });

   $scope.getSupplier_Name = Change_Supplier_Name;
       function Change_Supplier_Name(query) {
           var result = $filter('filter')($scope.supplier_list, {
           'supplier_name': query
             });
           return result;
   }

   $scope.SupplierChanged=function(supplier_gid,supplier_name){
    debugger;
        $scope.supplier_gid=supplier_gid;
        $scope.supplier_name=supplier_name;
   };

    $scope.change_paid=function(paid_values){
        if(paid_values==true){
                $scope.paid_status=1;
                $scope.supplier_name="";
                $scope.supplier_gid=0;
            }
            else{
                $scope.paid_status=0;
                $scope.supplier_name="";
                $scope.supplier_gid=0;
            }
    }
    $scope.check_radio=function(values){
        if($scope.branch_gid!=0){
                var datas={params:{"type":"GET","sub_type":"TICKET_RISE_ASSETS_NEW","filter":{"Branch_Gid":$scope.branch_gid,
                                   "AmcHeader_Type":values}}};
                $scope.loading();
                var supplier = Service_Ticket.get_asset_details(datas);
                        supplier.then(function(result) {
                         var res = result.data;
                         $scope.br_assets=res;
                         console.log($scope.br_assets);
                             }, function(err) {
                          alert(res);
                }).finally($scope.endloading);
        }
        else{
            alert("Give Branch Gid");
        }
    }



    var branch = Service_Ticket.get_branch_details();
        branch.then(function(result) {

            var branches_list = result.data.DATA;
            $scope.branches_list = branches_list;

        }, function() {
            alert(branches_list)

   });

   $scope.getBranch_Name = Change_Branch_Name;
       function Change_Branch_Name(query) {
           var result = $filter('filter')($scope.branches_list, {
           'branch_name': query
             });
           return result;
   }
   $scope.BranchChanged=function(br_gid){
        $scope.branch_gid=br_gid;
   };

   var category = Service_Ticket.get_category_details();
        category.then(function(result) {

            var category_list = result.data.DATA;
            $scope.category_list = category_list;

        }, function() {
            alert("No Data")

   });

   $scope.getCategory_Name = Change_Category_Name;
       function Change_Category_Name(query) {
           var result = $filter('filter')($scope.category_list, {
           'assetcat_subcatname': query
             });
           return result;
      }

    $scope.CategoryChanged=function(cat_gid){
    $scope.cate_gid=cat_gid;

    };

    $scope.ISAMC="N";
    $scope.amc_change=function(value){
       if(value==true){
            $scope.ISAMC="Y";
        }
        else{
         $scope.ISAMC="N";

        }
    }

    $scope.find_assets=function(asset_id){
        if(asset_id!=null){
            var datas={params:{"type":"GET","sub_type":"ASSET_DETAIL",
                "filter":{"Asset_Value": "","Cap_Date": "", "Asset_Code": "",
                "Branch":$scope.branch_gid,"Asset_cat":$scope.cate_gid,"asset_id":asset_id}}};
            $scope.loading();
            var asset = Service_Ticket.get_asset_details(datas);
            debugger;
                asset.then(function(result) {
                 var res = result.data;
                 $scope.br_assets=res;
                 console.log($scope.br_assets);
                     }, function(err) {
                  alert(res);
                }).finally($scope.endloading);
        }
        else{
            alert("Give Asset ID");
        }


    };

    $scope.assets = [];
    $scope.selected_assets=[];
    $scope.add_assets = function(value,index) {
        debugger;
                var f=find_duplicate(value);
                if(f){
                $scope.assets.push(value);
                }
                else{
                alert("Same Asset (OR) Multiple Vendor (OR) Differance Asset Type Not Allowed!...");
                }
            $scope.selected_assets=$scope.assets;

    };

    function find_duplicate(value){
        var count=0;
        var asset_assetcatgid=value.assetdetails_assetcatgid;
        var assetdetails_id=value.assetdetails_id;
        var assetdetails_supplier_id=value.supplier_gid;
        var assetdetails_supplier_name=value.supplier_name;
        var amcheader_type=value.amcheader_type;
        var keepGoing=true;
        if(assetdetails_supplier_id==undefined){assetdetails_supplier_id=0}
        if($scope.paid_status==1){assetdetails_supplier_id=0}
        if($scope.selected_assets.length==0){
            count=0;
        }
        else{
            for(j=0;j<$scope.selected_assets.length; j++){
                if($scope.paid_status){
                    count=0;
                }
                else if($scope.selected_assets[j].supplier_gid!=assetdetails_supplier_id){
                   count=1;
                }
                else if($scope.selected_assets[j].amcheader_type!=amcheader_type){
                   count=1;
                }
                if(keepGoing){
                    if($scope.selected_assets[j].assetdetails_id==assetdetails_id){
                         count=1;
                         keepGoing=false;
                    }
                }
            }
        }
        if(count==1 || keepGoing==false){
            return 0;
        }
        else{
            $scope.supplier_name=assetdetails_supplier_name;
            $scope.supplier_gid=assetdetails_supplier_id;
            return 1;
        }
    };

     $scope.delete_column = function(index){
             $scope.selected_assets.splice(index, 1);
     }


    $scope.create_ticket=function(){
        $scope.asset_cat_values=[];
        $scope.selected_assets;
        for (i = 0; i < $scope.selected_assets.length; i++) {

            var val={"TicketDetails_AssetDetailId":$scope.selected_assets[i].assetdetails_id,
                     "TicketDetails_AssetBarcode":$scope.selected_assets[i].assetdetails_barcode,
                     "TicketDetails_AssetDetailCatGid":$scope.selected_assets[i].assetdetails_assetcatgid};

            $scope.asset_cat_values.push(val);

        };
        var duedate;
        duedate=$filter('date')($scope.ticket_due_date, "yyyy-MM-dd");

        var datas={params:{"action":'INSERT',"type":'INSERT_TICKET_HEADER_DETAIL',
                          "filter":{"TicketHeader_DueDate":duedate,
                                 "TicketHeader_Status":"open",
                                 "Ticketheader_Summary":$scope.ticket_summary,
                                 "Ticketheader_Description":$scope.ticket_problem,
                                 "TicketHeader_AssignedTo":$scope.emp_gid,
                                 "TicketHeader_SupplierGid":$scope.supplier_gid,
                                 "TicketHeader_BranchGid":$scope.branch_gid,
                                 "TicketHeader_OnHold":"N",
                                 "TicketHeader_nopGid":$scope.ErrorCategory_Gid,
                                  "detail":$scope.asset_cat_values
                                  }
                         }
        };
        if($scope.supplier_gid==undefined){$scope.supplier_gid=0}
        if($scope.asset_cat_values.length!=0){
            if($scope.ErrorCategory_Gid!=0){
                if($scope.supplier_gid!=0){
                    $scope.loading();
                    var ticket_save = Service_Ticket.save_ticket_details(datas);
                        ticket_save.then(function(result) {
                            var res=JSON.parse(result.data);
                            if (res.MESSAGE[0]=== "SUCCESS") {
                            alert("Succesfully Ticket Created");
                            $window.location.href = "ServiceManagement/SM_Ticket_Summary/";
                            } else {
                          alert(JSON.stringify(res));
                          }
                        }, function(err) {
                          alert('Data Not Inserted');
                        }).finally($scope.endloading);
                }
                else{
                    alert("Give Supplier ");
                }
            }
            else{
            alert("Select Nature Of The Problem!");
            }
         }
         else
         {
            alert("Select Atleast One Asset!...");
         }

    };

    $scope.finaldata = [];

    var datas={params:{"type":"GET","sub_type":"ErrorCategory",
                "filter":{"ErrorCategory_Gid":0}}};
      $scope.loading();
     var nature = Service_Ticket.get_problem(datas);
        nature.then(function(result) {
        $scope.finaldata.push({
              "clustlist": result.data,
              "hierarchy_gid": 0,
              "childshow":true
        });
        console.log($scope.finaldata)
         var res = result.data;
         $scope.all_error=res;
         $scope.copy_all_error=res;
         console.log($scope.all_error);
         }, function(err) {
          alert("Data Not Found");
        }).finally($scope.endloading);


      $scope.rbtnChange=function(id,hir_id,problem_name){
          $scope.final_problem=problem_name;
          $scope.ErrorCategory_Gid=id;
          console.log($scope.ErrorCategory_Gid);
              $scope.show_parent=0;
              $scope.show_child=1;
              $scope.problem_value="";
              hir_id++
              if($scope.finaldata.length > hir_id){
                $scope.finaldata =$scope.finaldata.slice(0, hir_id);
              }
              var datas={params:{"type":"GET","sub_type":"ErrorCategory",
                    "filter":{"ErrorCategory_Gid":id}}};
                $scope.loading();
                 var child = Service_Ticket.get_problem(datas);
                    child.then(function(result) {
                    console.log(result);
                        if(result.data.length  !== 0){
                             $scope.finaldata.push({
                                  "clustlist": result.data,
                                  "hierarchy_gid": hir_id,
                                  "childshow":true
                            });}
                    $scope.endloading();
               });

      }

      $scope.clear_nop=function(){
            $scope.final_problem="Not Selected";
            $scope.ErrorCategory_Gid=0;

      }



  }]);


 myApp.service("Service_Ticket", function ($http) {

     this.getsupplierdata_sup = function (supp_gid) {
            var response=$http.post(Appname+"/Get_Service_Management/",{params:{"type":"Suppplier","sub_type":"DROPDOWN",
                                   "filter":{"Supplier_gid":supp_gid}}});
            return response;
     }


     this.get_branch_details = function () {
        var response=$http.post(Appname+"/Get_Category/",{params:{"type":"Branch","sub_type":"Summary",
                               "filter":{}}});
        return response;
     }

     this.get_category_details = function () {
        var response=$http.post(Appname+"/Get_Category/",{params:{"type":"Mode","sub_type":"Summary",
                               "filter":{}}});
        return response;
     }

     this.get_asset_details = function (data) {
        var response=$http.post(Appname+"/Get_Service_Management/",data);
        return response;
     }

     this.save_ticket_details=function(datas){
     var response=$http.post(Appname+"/Set_Service_Management/",datas);
     return response;
     }

      this.get_problem = function (data) {
        var response=$http.post(Appname+"/Get_Service_Management/",data);
        return response;
    }

 });





















</script>
<style>
    textarea { resize: none; }



















</style>

{% endblock %}

