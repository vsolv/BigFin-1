{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} Pre Scheduled Visit{% endblock %}
{% block content %}
{% verbatim %}
<div class="maincontent" id="maincontent">
    <div ng-app="Appaddschedule" ng-controller="Ctrladdschedule" class="container container1">
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <div class="col-lg-9 col-sm-9">
                    <h4>Plan Schedule - {{schedule_date | date : "dd.MMM.y"}}</h4>
                </div>
                <div ng-show="shwclnt" class="col-lg-3 col-sm-3">
                    <h4>Client Name - {{CLIENTNAME}}</h4>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-11 sidenavBar">
                <!--silde nav-->
                <md-sidenav class="md-sidenav-left" md-is-locked-open="$mdMedia('gt-md')"
                            md-whiteframe="4" md-component-id="left">
                    <md-toolbar class="md-theme-indigo">
                        <h1 class="md-toolbar-tools">Filter</h1>
                    </md-toolbar>
                    <div ng-include="'sidenavfilter'"></div>
                </md-sidenav>
                <!--end-->
            </div>
            <div class="col-md-8">
                <uib-accordion close-others="true">
                    <div uib-accordion-group class="panel-default" is-open="status.sales">
                        <uib-accordion-heading>
                            <p>Management Schedule
                                <i class="pull-right material-icons">{{!status.sales?'keyboard_arrow_up':'keyboard_arrow_down'}}</i>
                            </p>
                        </uib-accordion-heading>
                        <div class="row">
                            <div class="col-md-12"
                                 ng-repeat="pre in managemnts">
                                <div class="media ">
                                    <div class="media-left">
                                        <img alt="img" class="avatar rounded-1" height="44"
                                             src="/static/Images/userIcon1.png"
                                             width="44">
                                    </div>
                                    <div class="media-body">
                                        <h4 ng-class="pre.Order_by  != '1' ? 'highligter' : ''"
                                            class="media-heading custlabel"
                                            ng-click="viewDetails(pre,'')">
                                            <span>{{pre.customer_name}}</span> - <span> {{pre.location_name}}</span>
                                            -<span>{{pre.cluster_name}}</span> -<span style="color:blue">{{pre.sch_empname}}</span>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div uib-accordion-group class="panel-default" is-open="status.procust">
                        <uib-accordion-heading>
                            <p>Follow Ups
                                <i class="pull-right material-icons">{{!status.procust?'keyboard_arrow_up':'keyboard_arrow_down'}}</i>
                            </p>
                        </uib-accordion-heading>
                        <div class="col-md-12">
                            <div ng-repeat="pre in followups  | filter :{$:cusSearch}">
                                <div class="media">
                                    <div class="media-left">
                                        <img alt="img" class="avatar rounded-1" height="44"
                                             src="/static/Images/userIcon1.png"
                                             width="44">
                                    </div>
                                    <div class="media-body">
                                        <h4 class="media-heading custlabel"
                                            ng-click="viewDetails(pre,'')">
                                            <span>{{pre.customer_name}}</span> - <span> {{pre.location_name}}</span>
                                            -<span>{{pre.cluster_name}}</span> -<span style="color:blue">{{pre.sch_empname}}</span>
                                        </h4>

                                    </div>
                                    <div class="col-lg-2 col-sm-4"
                                         ng-repeat="chckbox in pre.schedule">
                                        <md-checkbox name="cname" ng-model="chckbox.sch_ischecked"
                                                     class="md-primary"
                                                     ng-disabled="chckbox.sch_type!=''">
                                            {{chckbox.sch_type}}
                                        </md-checkbox>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div uib-accordion-group class="panel-default" is-open="status.resch">
                        <uib-accordion-heading>
                            <p>Reschedule
                                <i class="pull-right material-icons">{{!status.resch?'keyboard_arrow_up':'keyboard_arrow_down'}}</i>
                            </p>
                        </uib-accordion-heading>
                        <div class="col-md-12">
                            <div ng-repeat="pre in reschedules  | filter :{$:cusSearch}">
                                <div class="media">
                                    <div class="media-left">
                                        <img alt="img" class="avatar rounded-1" height="44"
                                             src="/static/Images/userIcon1.png"
                                             width="44">
                                    </div>
                                    <div class="media-body">
                                        <h4 class="media-heading custlabel"
                                            ng-click="viewDetails(pre,'')">
                                            <span>{{pre.customer_name}}</span> - <span> {{pre.location_name}}</span>
                                            -<span>{{pre.cluster_name}}</span> -<span style="color:blue">{{pre.sch_empname}}</span>
                                        </h4>
                                    </div>
                                    <div class="col-lg-2 col-sm-4 "
                                         ng-repeat="chckbox in pre.schedule ">
                                        <md-checkbox name="cname" ng-model="chckbox.sch_ischecked"
                                                     class="md-primary"
                                                     ng-disabled="chckbox.sch_status=='RESCHEDULE'">
                                            {{chckbox.sch_type}}
                                        </md-checkbox>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div uib-accordion-group class="panel-default" is-open="status.others">
                        <uib-accordion-heading>
                            <p>Days Default Schedule<i class="pull-right material-icons">{{!status.others?'keyboard_arrow_up':'keyboard_arrow_down'}}</i>
                            </p>
                        </uib-accordion-heading>
                        <div class="row">
                            <div class="leftpanel affix">
                                <button type="button"
                                        class="custbutton buttonscroll"
                                        ng-click="POST_script_ALL()">
                                    S
                                </button>
                            </div>
                        </div>
                        <div class="col-md-12"
                             ng-repeat="pre in daysdefault  | filter :{$:cusSearch}"
                             ng-init="pre.schedulechecked=false">
                            <div class="media">
                                <div class="media-left">
                                    <img alt="img" class="avatar rounded-1" height="44"
                                         src="/static/Images/userIcon1.png"
                                         width="44">
                                </div>
                                <div class="media-body">
                                    <h4 ng-class="pre.Order_by  != '1' ? 'highligter' : ''"
                                        class="media-heading custlabel"
                                        ng-click="viewDetails(pre,'')">
                                        <span>{{pre.customer_name}}</span> -
                                        <span> {{pre.location_name}}</span>
                                        -<span>{{pre.cluster_name}}</span></h4>
                                    <div class="col-lg-12">
                                        <form name="myForm">
                                            <div class="col-lg-2 col-sm-4 "

                                                 ng-repeat="chckbox in pre.schedule ">
                                                <md-checkbox ng-disabled="pre.sch_edit=='N'" name="cname"
                                                             ng-click="pre.schedulechecked=true"
                                                             ng-model="chckbox.sch_ischecked"
                                                             class="md-primary">
                                                    {{chckbox.sch_type}}
                                                </md-checkbox>
                                            </div>
                                        </form>
                                        <div>
                                            <button ng-enabled="!chckbox.sch_ischecked" type="button"
                                                    class="btn btn-info custbutton" ng-disabled="pre.sch_edit=='N'"
                                                    ng-click="POST_script_DB(pre)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                        </div>
                    </div>
                    <div uib-accordion-group class="panel-default" is-open="status.add">
                        <uib-accordion-heading>
                            <p>ALL<i class="pull-right material-icons">{{!status.add?'keyboard_arrow_up':'keyboard_arrow_down'}}</i>
                            </p>
                        </uib-accordion-heading>

                        <div class="col-md-12">
                            <div class="row">
                                <div class="leftpanel affix">
                                    <button type="button"
                                            class="custbutton buttonscroll"
                                            ng-click="POST_script_ALL()">
                                        S
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <md-input-container class="md-block inputcontainer">
                                        <label>Selected Customer</label>
                                        <md-select ng-model="order" required>
                                            <md-optgroup label="Selected Customer">
                                                <md-option ng-value="opt.id" ng-repeat="opt in orderby">{{ opt.name }}
                                                </md-option>
                                            </md-optgroup>
                                        </md-select>
                                    </md-input-container>
                                </div>
                                <div class="col-md-4">
                                    <md-button class="md-fab md-mini md-primary custbutton"
                                               ng-click="openLeftMenu()"
                                               hide-gt-md>
                                        <md-icon>search</md-icon>
                                        <md-tooltip>Advance Search</md-tooltip>
                                    </md-button>
                                </div>
                                <div class="col-md-4 col-md-offset-4">
                                    <md-input-container class="md-block inputcontainer">
                                        <label>Customer Name</label>
                                        <!--<input ng-model="cusSearch"/>-->
                                        <input data-ng-model="searchTerm"/>
                                        <md-icon class="material-icons">search</md-icon>
                                    </md-input-container>
                                </div>
                            </div>
                            <div class="row">
                                <div infinite-scroll="loadMore()" infinite-scroll-distance="1">
                                    <div class="col-md-12"
                                         ng-show="pre.type=='ALL'"
                                         ng-init="pre.schedulechecked=false"
                                         ng-repeat="pre in logEventFilter = (schedule_detail | filter:searchTerm | limitTo:numberToDisplay) track by $index">
                                        <div class="media">
                                            <div class="media-left">
                                                <img alt="img" class="avatar rounded-1" height="44"
                                                     src="/static/Images/userIcon1.png"
                                                     width="44">
                                                <md-button class="md-icon-button"
                                                           ng-click="showComment(pre);">
                                                    <md-icon>insert_comment</md-icon>
                                                    <md-tooltip>Comments</md-tooltip>
                                                </md-button>
                                            </div>
                                            <div class="media-body">
                                                <h4 ng-class="pre.Order_by  != '1' ? 'highligter' : ''"
                                                    class="media-heading custlabel"
                                                    ng-click="viewDetails(pre,'')">
                                                    <span>{{pre.customer_name}}</span> -
                                                    <span> {{pre.location_name}}</span>
                                                    -<span>{{pre.cluster_name}}</span></h4>
                                                <div class="col-lg-12">
                                                    <form name="myForm">
                                                        <div class="col-lg-2 col-sm-4 "
                                                             ng-repeat="chckbox in pre.schedule ">
                                                            <md-checkbox name="cname" ng-model="chckbox.sch_ischecked"
                                                                         ng-click="pre.schedulechecked=true"
                                                                         class="md-primary"
                                                                         ng-disabled="pre.sch_edit=='N'"
                                                                         ng-disabled="chckbox.sch_status=='CLOSED' ">
                                                                {{chckbox.sch_type}}
                                                            </md-checkbox>
                                                        </div>
                                                    </form>

                                                    <div>
                                                        <button type="button" ng-disabled="pre.sch_edit=='N'"
                                                                class="btn btn-info custbutton"
                                                                ng-click="POST_script_DB(pre)">
                                                            Save
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <hr>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </uib-accordion>
            </div>
        </div>
        <div class="row" ng-show="sheinclud">
            <div class="col-lg-12 col-sm-12" ng-include="'comment'"></div>
        </div>
        <!--Modal  Customer Details (sales/collection/outstanding)-->
        <div ng-include="'viewDetails'"></div>
    </div>
</div>
{% endverbatim %}
<style>
    .LeftPanel {
     right: 1%;
    bottom: 20%;
    z-index: 10;
 }

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ngInfiniteScroll/1.3.0/ng-infinite-scroll.min.js"></script>
<script>
    var app = angular.module('Appaddschedule', ['ngMaterial', 'ui.bootstrap', 'treeControl', 'AppCommon', 'infinite-scroll'])
        .config(function($httpProvider) {
            $httpProvider.defaults.xsrfCookieName = 'csrftoken';
            $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
        });

    app.controller("Ctrladdschedule", ['$scope', 'Seraddschedule', '$filter', '$mdDialog', '$mdSidenav', 'SerCommon', '$mdToast',
        function($scope, addscheduleservice, $filter, $mdDialog, $mdSidenav, SerCommon, $mdToast) {

            var detai = JSON.parse(sessionStorage.getItem('Client'));
            $scope.Emp_gid=detai.employee_gid;
            var client = addscheduleservice.getclient('')
            client.then(function(result) {
                    $scope.clientname = [];
                    $scope.clntname = [];
                    $scope.clientname = JSON.parse(result.data);
                    if (detai != "") {
                        $scope.clntname = $filter('filter')($scope.clientname, function(item) {
                            return (item.client_gid == detai)
                        })
                        $scope.shwclnt = true;
                        $scope.CLIENTNAME = $scope.clntname[0].client_name;
                    } else {
                        return false;
                        $scope.shwclnt = false;
                    }
                }),
                function() {
                    alert('no data');
                };
            $scope.clname = detai;
            $scope.salesdetails=[];
            $scope.collection=[];
            $scope.outstanding=[];
            $scope.emp_gid = [];
            $scope.route_gid = [];
            $scope.cluster_gid = [];
            $scope.schedule_detail = [];
            $scope.numberToDisplay = 2;
            $scope.searchTerm = "";
            $scope.status = {
                employee: true,
                route: true,
                territory: true,
                mode: true,
                categroy: true,
                consititution: true,
                type: true,
                size: true
            }
            $scope.openLeftMenu = function() {
                $mdSidenav('left')
                    .toggle();
                setTimeout(function() {
                    document.documentElement.scrollTop = 0
                }, 1000);
            };
            $scope.treeOptions = {
                nodeChildren: "child_list"
            }
            $scope.emp_treeOptions = {
                nodeChildren: "child_list"
            }

            $scope.loading = function() {
                $mdDialog.show({
                    templateUrl: 'loaderSpinner',
                    parent: angular.element(document.body),
                    clickOutsideToClose: false
                });
            };
            $scope.orderby = [{
                    id: '-sch_status',
                    name: 'Bring Forward'
                },
                {
                    id: 'sch_status',
                    name: 'Send Back'
                },
            ];
            $scope.status = {
                sales: true,
                procust: true,
                others: true,
                add: true,
                resch: true,
            };

            $scope.endloading = function() {
                $mdDialog.hide();
            };

            $scope.cmd = [];
            $scope.showComment = function(data) {
                $scope.cmd.customer_name=data.customer_name+'-'+data.location_name;
                $scope.cmd.comment = '';
                var detail = JSON.parse(sessionStorage.getItem('today'));
                $scope.cmd.Emp_name = detail.employee_name;
                $scope.Emp_gid = detail.employee_gid;
                $scope.sheinclud = true;
                $scope.ref_no = data.customer_gid;
                getcmd($scope.ref_no);
                modalshow('comment_view');
            }

            function getcmd(refno) {
                var JSON_data = {};
                JSON_data = {
                    "Filters": [{
                        "Comment_For": "COMMENT_CUSTOMER",
                        "Ref_No": [refno],
                    }]
                };
                $scope.loading();
                var cmd_detail = addscheduleservice.getcmd('COMMENTS', 'TRANSACTION', JSON_data);
                cmd_detail.then(function(result) {
                    $scope.cmd.comment_details = result.data;
                }, function(err) {
                    $mdToast.show(SerCommon.new_toast('error', "Not Approved Successfully..!"));
                }).finally($scope.endloading);
                $scope.cmd.comment = '';
            }

            $scope.comment = function(remarks) {
                var JSON = {};
                JSON = {
                    "Employee_Gid": $scope.Emp_gid,
                    "Date":formatStringDate(new Date(),'yyyy-mm-dd hh:mm'),
                    "Comment_For": "COMMENT_CUSTOMER",
                    "EACH": [{
                        "Ref_No": $scope.ref_no,
                        "Remark": remarks
                    }]
                };

                var cmd_detail = addscheduleservice.setcmd('Insert', 'EACH', JSON);
                cmd_detail.then(function(result) {
                    if (result.data == 'SUCCESS') {
                        getcmd($scope.ref_no);
                    } else {
                        alert("Not Inserted successfully!.")
                    }
                }, function(err) {
                    alert("Not Approved successfully!.")
                });
            }
            var detail = JSON.parse(sessionStorage.getItem('today'));
            $scope.entity_gid = detail.entity_gid;
            var td = detail.date
            $scope.dbdate = convertdate(td);
            if (sessionStorage.getItem('cus_details') != null && sessionStorage.getItem('cus_details') != "") {
                var cus_details = JSON.parse(sessionStorage.getItem('cus_details'));
                sessionStorage.setItem('cus_details', "");
                $scope.schedule_date = cus_details.schedule_date;
            } else {
                $scope.schedule_date = formatDate(convertdate(td));
            }

            function loadData(emp_gid, type, route_gid, cluster_gid, clname) {
                $scope.loading();
                var custlist = addscheduleservice.getservice($scope.schedule_date, emp_gid, route_gid, cluster_gid, $scope.clname);
                custlist.then(function(custlist) {
                        $scope.schedule_detail.length = 0;
                        $scope.copyschedule_detail = custlist.data.customer;
                        $scope.schedule_detail = $filter('filter')($scope.copyschedule_detail, function(item) {
                            return (item.customer_isactive == 'Y')
                        })
                        $scope.managemnts = [];
                        $scope.followups = [];
                        $scope.reschedules = [];
                        $scope.daysdefault = [];

                        $scope.managemnts = $filter('filter')($scope.schedule_detail, function(item) {
                            return (item.Order_by != 1)
                        })
                        $scope.followups = $filter('filter')($scope.schedule_detail, function(item) {
                            return (item.sch_status == 'FOLLOWUP')
                        })
                        $scope.reschedules = $filter('filter')($scope.schedule_detail, function(item) {
                            return (item.sch_status == 'RESCHEDULE')
                        })
                        $scope.daysdefault = $filter('filter')($scope.schedule_detail, function(item) {
                            return (item.type == 'ROUTE')
                        })


                        if (type != 'search_emp' && type != 'serach_route') {
                            $scope.filterEmployee = custlist.data.employee;

                            if ($scope.filterEmployee.length > 0) {
                                if ($scope.filterEmployee.length == 1 && $scope.filterEmployee[0].child_list.length == 0) {
                                    if ($scope.emp_gid.indexOf($scope.filterEmployee[0].emp_gid) !== -1) {} else {
                                        $scope.emp_gid.push($scope.filterEmployee[0].emp_gid)
                                    }


                                }
                            }
                        }
                        if (type != 'serach_route') {
                            $scope.filterRoute = custlist.data.route;
                        }
                        $scope.clusterTree = custlist.data.terrirtory;
                        $scope.filterSize = custlist.data.size;
                        $scope.filterType = custlist.data.type;
                        $scope.filterCategroy = custlist.data.categroy;
                        $scope.filterConstitution = custlist.data.constitution;
                        $scope.filterMode = custlist.data.mode;
                    }, function() {
                        $mdToast.show(SerCommon.new_toast('danger', "Records Not Found..!"));
                    })
                    .finally($scope.endloading);
            };

            //INFINITY_SCROLL

            $scope.loadMore = function() {
                if ($scope.numberToDisplay + 5 < $scope.schedule_detail.length) {
                    $scope.numberToDisplay += 5;
                } else {
                    $scope.numberToDisplay = $scope.schedule_detail.length;
                }
            };

            loadData(JSON.stringify([]), '', JSON.stringify([]), JSON.stringify([]));

            $scope.filterEmpChange = function(node) {
                $scope.emp_gid = [];
                $scope.emp_gid.push(node.emp_gid)
                loadData(JSON.stringify($scope.emp_gid), 'search_emp', JSON.stringify([]), JSON.stringify([]));
            };

            $scope.filterRotue = function(type, index) {
                $scope.route_gid = [];
                $scope.cluster_gid = [];
                if (type != 'route') {
                    var count = $filter('filter')($scope.filterRoute[index].child_list, {
                        isChecked: true
                    }, 'exact');
                    if (count.length > 0) {
                        $scope.filterRoute[index].isChecked = true;
                    } else {
                        $scope.filterRoute[index].isChecked = false;
                    }
                } else {
                    var child = index.child_list;
                    if (index.isChecked == false) {
                        angular.forEach(child, function(user) {
                            user.isChecked = false;
                        });
                    } else {
                        angular.forEach(child, function(user) {
                            user.isChecked = true;
                        });
                    }
                }
                $scope.filterRoute.forEach(function(item) {
                    if (item.isChecked) {
                        $scope.route_gid.push(item.route_gid)
                    }
                    item.child_list.forEach(function(itemsub) {
                        if (itemsub.isChecked) {
                            $scope.cluster_gid.push(itemsub.cluster_gid)
                        }
                    });
                });
                loadData(JSON.stringify($scope.emp_gid), 'serach_route', JSON.stringify($scope.route_gid), JSON.stringify($scope.cluster_gid));
            }

            $scope.territorySelecte = function(node) {
                cluster_gid = [];
                cluster_gid.push(node.menu_id)
                loadData(JSON.stringify($scope.emp_gid), 'serach_route', JSON.stringify($scope.route_gid), JSON.stringify(cluster_gid));
            };

            $scope.filterchange = function() {
                $scope.searchData = getsearchData();
                var te = $scope.copyschedule_detail.filter(function(item) {
                    return ($scope.searchData.mode.length == 0 || $scope.searchData.mode.indexOf(item.customer_salemode_gid) != -1) &&
                        ($scope.searchData.categroy.length == 0 || $scope.searchData.categroy.indexOf(item.customer_category_gid) != -1) &&
                        ($scope.searchData.constitution.length == 0 || $scope.searchData.constitution.indexOf(item.customer_constitution_gid) != -1) &&
                        ($scope.searchData.type.length == 0 || $scope.searchData.type.indexOf(item.customer_type) != -1) &&
                        ($scope.searchData.size.length == 0 || $scope.searchData.size.indexOf(item.customer_size_gid) != -1)
                });
                $scope.schedule_detail = te;
            };

            function getsearchData() {
                var data = {};
                var size = [];
                var mode = [];
                var categroy = [];
                var constitution = [];
                var type = [];

                $scope.filterMode.forEach(function(item) {
                    if (item.isChecked) {
                        mode.push(item.customer_salemode_gid)
                    }
                });

                $scope.filterCategroy.forEach(function(item) {
                    if (item.isChecked) {
                        categroy.push(item.customer_category_gid)
                    }
                });

                $scope.filterConstitution.forEach(function(item) {
                    if (item.isChecked) {
                        constitution.push(item.customer_constitution_gid)
                    }
                });

                $scope.filterType.forEach(function(item) {
                    if (item.isChecked) {
                        type.push(item.customer_type)
                    }
                });

                $scope.filterSize.forEach(function(item) {
                    if (item.isChecked) {
                        size.push(item.customer_size_gid)
                    }
                });
                data['mode'] = mode;
                data['categroy'] = categroy;
                data['constitution'] = constitution;
                data['type'] = type;
                data['size'] = size;
                return data;
            };

            $scope.POST_script_ALL = function() {

                if ($scope.emp_gid.length != 1) {
                    alert('Please select any one employee!.');
                    return false;
                }
                var schedule_filter = $filter('filter')($scope.schedule_detail, {
                    schedulechecked: true
                }, 'exact');
                var bulkinsert = [];

                if (schedule_filter.length == 0) {
                    alert("Select Any One Schedule");
                    $scope.endloading();
                    return false;
                };
                schedule_filter.forEach(function(user) {
                    var Schedule_Type_Gid = [];
                    var Schedule_Gid = [];
                    var is_remove = 'N'
                    user.schedule.forEach(function(type) {

                        if (type.sch_ischecked == true && type.sch_gid == "") {
                            Schedule_Type_Gid.push(type.schType_gid);
                        }
                        if (type.sch_ischecked == false && type.sch_gid != "") {
                            Schedule_Gid.push(type.sch_gid);
                            is_remove = 'Y'
                        }

                    })

                    bulkinsert.push({
                        "Customer_Gid": user.customer_gid,
                        "Schedule_Type_Gid": Schedule_Type_Gid,
                        "Is_Remove": is_remove,
                        "Schedule_Gid": Schedule_Gid,
                        "Remark": "remarks"
                    });
                });
                var insert_flag = 0;
                var delete_flag = 0;

                var filter_trn = {};
                var BULK_SCHEDULE = {
                    BULK_SCHEDULE: bulkinsert
                };
                var en = addscheduleservice.bulkschedule($scope.emp_gid[0], BULK_SCHEDULE, '', 'SCHEDULE_BULK', $scope.schedule_date);
                en.then(function(endata) {
                    if (endata.data[0] == "SUCCESS") {
                        $mdToast.show(SerCommon.new_toast('success', "Data Inserted Successfully..!"));
                        loadData(JSON.stringify($scope.emp_gid), '', JSON.stringify([]), JSON.stringify([]));
                    }
                }, function() {
                    $mdToast.show(SerCommon.new_toast('danger', "Data Not Inserted Successfully..!"));
                });
            }

            $scope.POST_script_DB = function(cus_dtl) {
                if ($scope.emp_gid.length != 1) {
                    alert('Please select any one employee!.');
                    return false;
                }
                $scope.loading();
                var insert_flag = 0;
                var delete_flag = 0;
                var scheduledtl = cus_dtl.schedule;
                var rIndex = $scope.schedule_detail.indexOf(cus_dtl)

                scheduledtl.forEach(function(sch_dtl) {
                    if (sch_dtl.sch_gid == '' & sch_dtl.sch_ischecked == true) {
                        if ($scope.filterEmployee.length == 1 && $scope.filterEmployee[0].child_list.length == 0) {
                            if (cus_dtl.sch_count >= 10) {
                                var If_confirm = confirm("you already have more than 10 schedules, Do you want to add more");
                                if (!If_confirm) {
                                    loadData();
                                    return false;
                                }
                            }
                        }
                        var en = addscheduleservice.singleschedule($scope.emp_gid[0], cus_dtl.customer_gid, sch_dtl.schType_gid, 'SCHEDULE', $scope.schedule_date);
                        en.then(function(en) {
                            var rr = $scope.schedule_detail[rIndex].schedule.indexOf(sch_dtl)
                            $scope.schedule_detail[rIndex].schedule[rr].sch_gid = JSON.parse(en.data)[0]
                            $scope.schedule_detail[rIndex].schedule[rr].sch_status = 'OPENED'

                            if (insert_flag == 0) {
                                $mdToast.show(SerCommon.new_toast('success', "Data Inserted Successfully..!"));
                                insert_flag++;
                            }

                        }, function() {
                            $mdToast.show(SerCommon.new_toast('error', "Data Not Inserted Successfully..!"));
                        });
                    } else if (sch_dtl.sch_gid != '' & sch_dtl.sch_ischecked == false) {
                        var en = addscheduleservice.delete_sechdule(sch_dtl.sch_gid);
                        en.then(function(en) {
                            var rr = $scope.schedule_detail[rIndex].schedule.indexOf(sch_dtl)
                            $scope.schedule_detail[rIndex].schedule[rr].sch_gid = ''
                            $scope.schedule_detail[rIndex].schedule[rr].sch_status = ''
                            if (delete_flag == 0) {
                                $mdToast.show(SerCommon.new_toast('success', "Data Deleted Successfully..!"));
                                delete_flag++;
                            }
                        }, function() {
                            $mdToast.show(SerCommon.new_toast('error', "Data Not Deleted Successfully..!"));
                        });
                    }
                })
                $scope.endloading();
            }


            $scope.viewDetails = function(viewDetail,group) {
                $scope.salesdetails=[];
                $scope.collection=[];
                $scope.outstanding=[];
                $scope.loading()
                $scope.viewDetail = viewDetail;

                data={'ACTION':'Common','Outstanding_Type':'OUTSTANDING_REPORT_INVOICE_WISE','Outstanding_SubType':'BUCKET'};
                data['Customer_Gid']=viewDetail.customer_gid;
                data['CustGroup_Gid']=viewDetail.customer_custgroup_gid;
                data['Outstanding_Customer_Group_Gid']=0;
                data['Customer_Name']='';
                data['Employee_Gid']=$scope.Emp_gid;
                data['CLASSIFICATION']= {"Entity_Gid": [$scope.entity_gid]};

                if (group=='GroupWise' ) {
                    data['Outstanding_Customer_Group_Gid']=viewDetail.customer_group_gid;
                }else{
                    $scope.rbtnCustomerGroup="CustomerWise";
                }
                 var outstanding = addscheduleservice.getoutstanding(data,30)
                    outstanding.then(function(result) {
                        if(result.data.MESSAGE=="FOUND"){
                            $scope.isGroupwise=(result.data.outstanding_hierarchy=='N'?true:false);
                            $scope.salesdetails= result.data.sales_history;
                            $scope.collection=result.data.collection_history;
                            $scope.outstanding = result.data.outstanding_detail;
                        }else{
                            $scope.isGroupwise=true;
                            $scope.salesdetails=[];
                            $scope.collection=[];
                            $scope.outstanding=[];
                        }
                    }, function(err) {
                        alert('Server Error!.');
                    }).finally($scope.endloading);

                    modalshow('mdl_view');
            };

            $scope.totalbilling = function(data) {
                var totall = 0;
                if (data.length == 0) {
                    return totall;
                } else {
                    for (var i = 0; i < data.length; i++) {
                        totall = totall + data[i].pending;
                    }
                    return totall;
                }
            }

        }
    ])

    app.service("Seraddschedule", function($http) {
        this.getservice = function(date, emp_gid, route_gid, cluster_gid, Client_gid) {
            var response = $http.get(Appname + "/getCustFilter/", {
                params: {
                    "action": "view",
                    "f_date": date,
                    "emp_gid": emp_gid,
                    "route_gid": route_gid,
                    "cluster_gid": cluster_gid,
                    "Client_gid": Client_gid
                }
            });
            return response;
        }
        this.getoutstanding = function(r) {
            var respons = $http.post(Appname + "/outstanding_fet_get/", {
                parms: {
                    "customer_gid": r,
                    "ACTION": "outstandingcustomer"
                }
            });
            return respons;
        }
        this.getoutstand = function(r) {
            var respons = $http.post(Appname + "/outstanding_fet_get/", {
                parms: {
                    "customer_gid": r,
                    "ACTION": "OutstandingCustomergroup"
                }
            });
            return respons;
        }
        this.singleschedule = function(emp_gid, cus_gid, sch_typegid, type, date) {
            var response = $http.post(Appname + "/add_schedule/", {
                parms: {
                    "emp_gid": emp_gid,
                    "customer_gid": cus_gid,
                    "schedule_type_gid": sch_typegid,
                    "TYPE": type,
                    "Date": date
                }
            });
            return response;
        }
        this.bulkschedule = function(emp_gid, cus_gid, sch_typegid, type, date) {
            var response = $http.post(Appname + "/add_schedule/", {
                parms: {
                    "emp_gid": emp_gid,
                    "data": cus_gid,
                    "schedule_type_gid": sch_typegid,
                    "TYPE": type,
                    "Date": date
                }
            });
            return response;
        }
        this.delete_sechdule = function(schedule_gid) {
            var response = $http.post(Appname + "/add_schedule/", {
                parms: {
                    "schedule_gid": schedule_gid,
                    "TYPE": "DELETE"
                }
            });
            return response;
        }
        this.getcollection = function(p) {
            var respon = $http.post(Appname + "/collection_history_fet/", {
                parms: {
                    "custid": p
                }
            });
            return respon;
        }
        this.getsales = function(i) {
            var responsee = $http.post(Appname + "/sales_history_fet_get/", {
                parms: {
                    "customer_gid": i
                }
            });
            return responsee;
        }
        this.getoutstanding = function(data,limit) {
        var values={'data':data,'limit':limit}
            var respons = $http.post(Appname + "/outstanding_get/", values );
            return respons;
        }
        this.getcmd = function(action, type, json) {
            var response = $http.post(Appname + "/commentget/", {
                params: {

                    "action": action,
                    "type": type,
                    "json": json
                }
            });
            return response;
        };

        this.setcmd = function(action, type, json) {
            var response = $http.post(Appname + "/commentset/", {
                params: {
                    "action": action,
                    "type": type,
                    "json": json
                }
            });
            return response;
        };
        this.getclient = function(client_gid) {
            var response = $http.get(Appname + "/client_get/", {
                params: {
                    "client_gid": client_gid
                }
            });
            return response;
        }
    });


</script>
{% endblock %}
